<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/67b74b86-a273-4ad7-9ed5-0f97276412eaCombined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Protocol Bridging with ServiceBus and WCF4 (CSAzureServiceBusProtocolBridging)</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Protocol Bridging with ServiceBus and WCF4 (CSAzureServiceBusProtocolBridging)</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Microsoft Azure
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Service Bus, AppFabric
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Cloud
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">4/16/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MS-LPL</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/CSAzureServiceBusProtocolBr-7b28ab4f">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<p style="font-family:Courier New">&nbsp;<a href="http://www.microsoft.com/click/services/Redirect2.ashx?CR_CC=200144420" ><img id="79969" src="description/120x90_Azure_web_EN_US.jpg" alt="" width="360" height="90"></a></p>
<h1>Protocol Bridging with ServiceBus and WCF4 in Windows Azure</h1>
<h2>Introduction</h2>
<p class="MsoNormal">The <strong>AppFabric Service Bus</strong> provides the communication infrastructure that protects developers from having to create the complex code necessary to achieve seamless connectivity. It allows you to expose a service to the
 Internet from behind your firewall or NAT.</p>
<p class="MsoNormal">WCF4 includes a new routing service found in the <strong><a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.ServiceModel.Routing.aspx"  title="Auto generated link to System.ServiceModel.Routing">System.ServiceModel.Routing</a></strong> namespace. The Routing Service is designed to act as a generic, configurable SOAP intermediary. It allows you to configure Content Based Routing,
 set up Protocol Bridging, and handle communication errors that you encounter. The Routing Service also makes it possible for you to update your Routing Configuration while the Routing Service is running without restarting the service.</p>
<p class="MsoNormal">This sample demos how to combine <strong>AppFabric Service Bus</strong> and
<strong>WCF4 Routing Service</strong> to expose an existing net.tcp WCF service through Service Bus using http protocol. For the technical detail, please see the
<a href="#references">References</a> section.</p>
<p class="MsoNormal">This solution contains 4 projects:</p>
<p class="MsoListParagraphCxSpFirst" style="text-indent:-.25in"><span style="font-family:Symbol"><span>&bull;<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><strong>Common</strong> is a class library, contains classes which are shared by all projects.</p>
<p class="MsoListParagraphCxSpMiddle" style="text-indent:-.25in"><span style="font-family:Symbol"><span>&bull;<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><strong>Service</strong> is a console application that hosts a WCF service on local machine.</p>
<p class="MsoListParagraphCxSpMiddle" style="text-indent:-.25in"><span style="font-family:Symbol"><span>&bull;<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><strong>RouterService</strong> is a console application, exposes a Routing Service through Service Bus and routes requests to Service that is running on the same machine as RouterService.</p>
<p class="MsoListParagraphCxSpLast" style="text-indent:-.25in"><span style="font-family:Symbol"><span>&bull;<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><strong>Client</strong> is a console application, consumes the WCF service through Service Bus.</p>
<p class="MsoNormal">&nbsp;</p>
<p class="MsoListParagraph" style="margin-right:5.5pt; text-align:right"><a href="http://www.microsoft.com/click/services/Redirect2.ashx?CR_CC=200144420"><span style="color:windowtext; text-decoration:none"><span><img src="description/image.png" alt="" width="120" height="90" align="middle">
</span></span></a><br>
<a href="http://www.microsoft.com/click/services/Redirect2.ashx?CR_CC=200144420">Try Windows Azure for free for 90 Days!</a></p>
<h2>Building the Sample</h2>
<p class="MsoNormal">You need to install Windows Azure AppFabric SDK in order to build this code sample.</p>
<h2>Running the Sample</h2>
<p class="MsoNormal"><strong>Step 1</strong>: Run Visual Studio as administrator and open the solution (CSAzureServiceBusProtocolBridging.sln) in Visual Studio.</p>
<p class="MsoNormal"><strong>Step 2</strong>: Input your Service Bus settings.</p>
<p class="MsoNormal">Please open <strong>Settings.cs</strong> class file which belongs to
<strong>Common</strong> project by double clicking it in <strong>Solution Explorer</strong>. Then please input your Service Bus namespace, issuer name and issuer secret. If you don't know how to get these, please refer to
<a href="http://msdn.microsoft.com/en-us/gg282248">Getting Started: Creating a Service Bus Namespace</a>.</p>
<p class="MsoNormal"><strong>Step 3</strong>: Run applications.</p>
<p class="MsoNormal">Please right-click the solution in <strong>Solution Explorer</strong> then click
<strong>Properties</strong> to open the <strong>Solution Property Pages </strong>
window. In the Solution Property Pages window, select <strong>Startup Project</strong> tab and select
<strong>Multiple startup projects</strong> option. Set the <strong>RouterService</strong> project as
<strong>Start without debugging</strong>, the <strong>Service</strong> project as Start and finally click the
<strong>OK</strong> button to close the <strong>Solution Property Pages </strong>
window.</p>
<p class="MsoNormal">Click <strong>Debug &gt; Start Debugging</strong> (or press F5) to start up
<strong>Service</strong> project and <strong>RouterService</strong> project. Wait until both console applications say &quot;Service is Ready...&quot;. It may need several seconds for
<strong>RouterService</strong> application to connect to Service Bus and expose the service on it. Back to the
<strong>Solution Explorer</strong>, please right-click the Client project and select
<strong>Debug &gt; Start new instance</strong> to start up the <strong>Client</strong> application.</p>
<p class="MsoNormal">It also may needs seconds for <strong>Client</strong> application to connect to Service Bus and consume the service. Finally you will get similar outputs like below.</p>
<p class="MsoNormal"><strong>Client application console: </strong></p>
<p class="MsoNormal"><em>Initializing proxy.<br>
Calling Add(36, 15) via <a href="https://[namespace].servicebus.windows.net/MyService">
https://[namespace].servicebus.windows.net/MyService</a><br>
Result: 51<br>
Please press [Enter] to exit. </em></p>
<p class="MsoNormal"><strong>Service application console: </strong></p>
<p class="MsoNormal"><em>Starting service.<br>
Service is ready at net.tcp://localhost:9090/MyService<br>
Please press [Enter] to exit.<br>
Add(36, 15) is called. </em></p>
<p class="MsoNormal"><span>&nbsp;</span></p>
<p class="MsoNormal"><strong>Why can't I debug RouterService project and Client project in the same time?
</strong></p>
<p class="MsoNormal">If you debug RouterService and Client in the same time, the Client application will receive the following error when it calls the service.</p>
<p class="MsoNormal"><em>Multiple headers with name 'VsDebuggerCausalityData'<br>
and namespace 'http://schemas.microsoft.com/vstudio/diagnostics/servicemodelsink' found.
</em></p>
<p class="MsoNormal">This happens because when debugging WCF client application (WCF service consumer) in Visual Studio, Visual Studio will append a 'VsDebuggerCausalityData' header to the request. In this sample, Client sends request to Service Bus and RouterService
 receives request from Service Bus and sends request to Service. The same request is sent twice, thus, if we debug both Client and RouterService, the 'VsDebuggerCausalityData' header will be appended twice.</p>
<p class="MsoNormal">Solution will be either of following options:</p>
<p class="MsoNormal">1) Do not debug them at the same time, either debug Client project or Service project. That means one of them needs to start up without debugging.</p>
<p class="MsoNormal">2) Temporarily disable debugger support for WCF by running the following command:<br>
<em>&quot;C:\Program Files\Microsoft Visual Studio 10.0\Common7\IDE\vsdiag_regwcf.exe&quot; &ndash;u<br>
</em>Then we can debug both Client project and Service project. After debugging, you may need to rollback the change and enable debugger support for WCF:<br>
<em>&quot;C:\Program Files\Microsoft Visual Studio 10.0\Common7\IDE\vsdiag_regwcf.exe&quot; &ndash;i</em></p>
<p class="MsoNormal">&nbsp;</p>
<h2>More Information</h2>
<p class="MsoNormal" style="line-height:normal"><span><a href="http://msdn.microsoft.com/en-us/library/ee732537.aspx">AppFabric Service Bus</a>
</span></p>
<p class="MsoNormal" style="line-height:normal"><span><a href="http://msdn.microsoft.com/en-us/gg282251">Introduction to the AppFabric Service Bus &gt; Exercise 1: Getting a Basic Client and Service Working</a>
</span></p>
<p class="MsoNormal" style="line-height:normal"><span><a href="http://msdn.microsoft.com/en-us/gg465230">What's New in WCF 4? &gt; Exercise 8: Protocol Bridging</a>
</span></p>
<p class="MsoNormal">&nbsp;</p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img src="description/95e3bc78-76ea-4f7c-8b0e-445ca740f249image.png" alt="">
</a></div>

</div>


    </div>
</body>
</html>
