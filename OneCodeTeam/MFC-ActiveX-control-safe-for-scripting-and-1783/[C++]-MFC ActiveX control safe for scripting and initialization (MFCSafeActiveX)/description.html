<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/9e116645-9d9a-4566-82a8-7b29a5b324f1Combined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>MFC ActiveX control safe for scripting and initialization (MFCSafeActiveX)</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>MFC ActiveX control safe for scripting and initialization (MFCSafeActiveX)</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            COM, MFC
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            ActiveX
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">5/5/2011</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/MFCSafeActiveX-690cd758">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<p style="font-family:Courier New"></p>
<h2>ACTIVEX CONTROL DLL : MFCSafeActiveX Project Overview</h2>
<p style="font-family:Courier New"></p>
<h3>Use:</h3>
<p style="font-family:Courier New"><br>
By default, MFC ActiveX controls (e.g. the MFCActiveX sample) are not marked <br>
as Safe for Scripting and Safe for Initialization. This becomes apparent when <br>
the control is hosted in Internet Explorer with the security level set to <br>
medium or high. In either of these modes, warnings may be displayed that the <br>
control's data is not safe or that the control may not be safe for scripts to <br>
use. <br>
<br>
There are two methods to mark an ActiveX control as safe for scripting and <br>
initialization, and eliminate these warnings and errors.<br>
<br>
1. Implement the IObjectSafety interface in the control.<br>
<br>
2. Modify the control's DllRegisterServer function to mark the control &quot;safe&quot;<br>
in the registry. It results in these entries in the registry:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;HKEY_CLASSES_ROOT\Component Categories\<br>
&nbsp;&nbsp;&nbsp;&nbsp;{7DD95801-9882-11CF-9FA9-00AA006C42C4} &nbsp;// CATID_SafeForScripting<br>
&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;HKEY_CLASSES_ROOT\Component Categories\<br>
&nbsp;&nbsp;&nbsp;&nbsp;{7DD95802-9882-11CF-9FA9-00AA006C42C4} &nbsp;// CATID_SafeForInitializing<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;// register the control as safe for scripting<br>
&nbsp;&nbsp;&nbsp;&nbsp;HKEY_CLASSES_ROOT\CLSID\{&quot;your controls GUID&quot;}\Implemented Categories\<br>
&nbsp;&nbsp;&nbsp;&nbsp;{7DD95801-9882-11CF-9FA9-00AA006C42C4} &nbsp;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;// register the control as safe for initialization<br>
&nbsp;&nbsp;&nbsp;&nbsp;HKEY_CLASSES_ROOT\CLSID\{&quot;your controls GUID&quot;}\Implemented Categories\<br>
&nbsp;&nbsp;&nbsp;&nbsp;{7DD95802-9882-11CF-9FA9-00AA006C42C4} &nbsp;<br>
<br>
This sample convers the second of these methods.<br>
<br>
MFCSafeActiveX exposes the following items:<br>
<br>
1. A MFC ActiveX control short-named MFCSafeActiveX that is safe for <br>
scripting and initialization<br>
<br>
Program ID: MFCSAFEACTIVEX.MFCSafeActiveXCtrl.1<br>
CLSID_MFCSafeActiveX: 1EBAE592-7515-43C2-A6F1-CDEEDF3FD82B<br>
DIID__DMFCSafeActiveX: 6267760D-4EDC-430A-A94F-1181971ABA02<br>
DIID__DMFCSafeActiveXEvents: 050C9E59-ADA3-440A-92B4-59AE97009569<br>
LIBID_MFCSafeActiveXLib: 098DB52D-2AAE-499B-B959-A430BA0FF357<br>
<br>
Dialogs:<br>
// The main dialog of the control<br>
IDD_MAINDIALOG<br>
// The property page of the control<br>
IDD_PROPPAGE_MFCACTIVEX<br>
<br>
Properties:<br>
// With both get and set accessor methods<br>
FLOAT FloatProperty<br>
<br>
Methods:<br>
// HelloWorld returns a BSTR &quot;HelloWorld&quot;<br>
BSTR HelloWorld(void);<br>
// GetProcessThreadID outputs the running process ID and thread ID<br>
void GetProcessThreadID(LONG* pdwProcessId, LONG* pdwThreadId);<br>
<br>
Events:<br>
// FloatPropertyChanging is fired before new value is set to the <br>
// FloatProperty property. The Cancel parameter allows the client to cancel <br>
// the change of FloatProperty.<br>
void FloatPropertyChanging(FLOAT NewValue, VARIANT_BOOL* Cancel);<br>
<br>
</p>
<h3>Project Relation:</h3>
<p style="font-family:Courier New"><br>
HTMLEmbedActiveX -&gt; MFCSafeActiveX<br>
HTMLEmbedActiveX demonstrates the use of the safe MFC ActiveX control. <br>
<br>
</p>
<h3>Build:</h3>
<p style="font-family:Courier New"><br>
To build MFCSafeActiveX, 1. run Visual Studio as administrator because the <br>
control needs to be registered into HKCR. 2. Be sure to build the <br>
MFCSafeActiveX project using the Release configuration.<br>
<br>
</p>
<h3>Creation:</h3>
<p style="font-family:Courier New"><br>
A. Creating the project<br>
<br>
Step1. Create a Visual C&#43;&#43; / MFC / MFC ActiveX Control project named <br>
MFCSafeActiveX in Visual Studio 2008.<br>
<br>
Step2. In the page Control Settings, select &quot;Create control based on&quot; as
<br>
STATIC. Under &quot;Additional features&quot;, check &quot;Activates when visible&quot; and
<br>
&quot;Flicker-free activation&quot;, and un-check &quot;Has an About box dialog&quot;.<br>
<br>
B. Adding a main dialog to the control<br>
<br>
Step1. In Resource View, insert a new dialog resource and change the control <br>
ID to IDD_MAINDIALOG.<br>
<br>
Step2. Change the default properties of the dialog to Border - None, <br>
Style - Child, System Menu - False, Visible - True.<br>
<br>
Step3. Create a class for the dialog, by right clicking on the dialog and <br>
selecting Add Class. Name the class CMainDialog, with the base class CDialog.<br>
<br>
Step4. Add the member variable m_MainDialog of the type CMainDialog to the <br>
class CMFCSafeActiveXCtrl.<br>
<br>
Step5. Select the class CMFCSafeActiveXCtrl in Class View. In the Properties <br>
sheet, select the Messages icon. Add OnCreate for the WM_CREATE message. <br>
<br>
Step6. Open MFCSafeActiveXCtrl.cpp, and add the following code to the <br>
OnCreate method to create the main dialog.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;m_MainDialog.Create(IDD_MAINDIALOG, this);<br>
<br>
Step7. Add the following code to the OnDraw method to size the main dialog <br>
window and fill the background.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;m_MainDialog.MoveWindow(rcBounds, TRUE);<br>
&nbsp;&nbsp;&nbsp;&nbsp;CBrush brBackGnd(TranslateColor(AmbientBackColor()));<br>
&nbsp;&nbsp;&nbsp;&nbsp;pdc-&gt;FillRect(rcBounds, &brBackGnd);<br>
<br>
C. Adding Properties to the ActiveX control<br>
<br>
Step1. In Class View, expand the element MFCSafeActiveXLib. Right click on <br>
_DMFCSafeActiveX, and click on Add, Add Property. In the Add Property Wizard <br>
dialog, select FLOAT for Property type, and enter &quot;FloatProperty&quot; for <br>
property name. Select &quot;Get/Set methods&quot; to create the methods <br>
GetFloatProperty and SetFloatProperty.<br>
<br>
Step2. In the class CMFCSafeActiveXCtrl, add a member variable, FLOAT <br>
m_FloatField. In the class's contructor, set the variable's default value to <br>
0.0f.<br>
<br>
Step3. Associate the Get/Set methods of FloatProperty with m_FloatField.<br>
<br>
D. Adding Methods to the ActiveX control<br>
<br>
Step1. In Class View, expand the element MFCSafeActiveXLib. Right click on <br>
_DMFCSafeActiveX, and click on Add, Add Method. In the Add Method Wizard <br>
dialog, select BSTR for the return type, and enter &quot;HelloWorld&quot; for Method
<br>
name.<br>
<br>
With the almost same steps, the method GetProcessThreadID is added to get the<br>
executing process ID and thread ID:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;void GetProcessThreadID(LONG* pdwProcessId, LONG* pdwThreadId);<br>
<br>
E. Adding Events to the ActiveX control<br>
<br>
Step1. In Class View, right click on CMFCSafeActiveXCtrl, select Add, Add <br>
Event. In the Add Event Wizard, enter &quot;FloatPropertyChanging&quot; for Event name
<br>
and add two parameters: FLOAT NewValue, VARIANT_BOOL* Cancel. <br>
<br>
Step2. The event &quot;FloatPropertyChanging&quot; is fired in SetFloatProperty:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;void CMFCSafeActiveXCtrl::SetFloatProperty(FLOAT newVal)<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AFX_MANAGE_STATE(AfxGetStaticModuleState());<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Fire the event, FloatPropertyChanging<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VARIANT_BOOL cancel = VARIANT_FALSE;
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FloatPropertyChanging(newVal, &cancel);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (cancel == VARIANT_FALSE)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_fField = newVal;&nbsp;&nbsp;&nbsp;&nbsp;// Save the new value<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetModifiedFlag();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Display the new value in the control UI<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CString strFloatProp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strFloatProp.Format(_T(&quot;%f&quot;), m_fField);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_MainDialog.m_StaticFloatProperty.SetWindowTextW(strFloatProp);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// else, do nothing.<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
F. Marking the control as Safe for Scripting and Initialization<br>
<br>
Step1. Implement the CreateComponentCategory, RegisterCLSIDInCategory, and <br>
UnRegisterCLSIDInCategory helper functions in cathelp.h/cpp files.<br>
<br>
Step2. Modify MFCSafeActiveX.cpp to add CLSID_SafeItem at the beginning of <br>
the file. The value of CLSID_SafeItem is taken from IMPLEMENT_OLECREATE_EX <br>
in MFCSafeActiveXCtrl.cpp. It is actually the CLSID of the ActiveX control.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;const CATID CLSID_SafeItem =<br>
&nbsp;&nbsp;&nbsp;&nbsp;{ 0x1ebae592, 0x7515, 0x43c2,<br>
&nbsp;&nbsp;&nbsp;&nbsp;{ 0xa6, 0xf1, 0xcd, 0xee, 0xdf, 0x3f, 0xd8, 0x2b}};<br>
<br>
Step3. Modify the DllRegisterServer method in MFCSafeActiveX.cpp, to mark the<br>
control as safe for initialization and scripting using the helper functions<br>
in cathelp.h.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;// Mark the control as safe for initializing. (Added)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;hr = CreateComponentCategory(CATID_SafeForInitializing, <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L&quot;Controls safely initializable from persistent data!&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;if (FAILED(hr))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return hr;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;hr = RegisterCLSIDInCategory(CLSID_SafeItem, CATID_SafeForInitializing);<br>
&nbsp;&nbsp;&nbsp;&nbsp;if (FAILED(hr))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return hr;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;// Mark the control as safe for scripting. (Added)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;hr = CreateComponentCategory(CATID_SafeForScripting,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L&quot;Controls safely &nbsp;scriptable!&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;if (FAILED(hr))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return hr;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;hr = RegisterCLSIDInCategory(CLSID_SafeItem, CATID_SafeForScripting);<br>
&nbsp;&nbsp;&nbsp;&nbsp;if (FAILED(hr))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return hr;<br>
<br>
Step4. Modify the DllUnregisterServer method in MFCSafeActiveX.cpp, to remove<br>
the entries from the registry using the helper functions in cathelp.h.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;// Remove entries from the registry.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;hr = UnRegisterCLSIDInCategory(CLSID_SafeItem, CATID_SafeForInitializing);<br>
&nbsp;&nbsp;&nbsp;&nbsp;if (FAILED(hr))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return hr;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;hr = UnRegisterCLSIDInCategory(CLSID_SafeItem, CATID_SafeForScripting);<br>
&nbsp;&nbsp;&nbsp;&nbsp;if (FAILED(hr))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return hr;<br>
<br>
</p>
<h3>References:</h3>
<p style="font-family:Courier New"><br>
How to mark MFC ActiveX controls as Safe for Scripting and Initialization<br>
<a  href="http://support.microsoft.com/kb/161873">http://support.microsoft.com/kb/161873</a><br>
<br>
SafeCtl.exe implements IObjectSafety in ActiveX control<br>
<a  href="http://support.microsoft.com/kb/164119">http://support.microsoft.com/kb/164119</a><br>
<br>
The ABCs of MFC ActiveX Controls<br>
<a  href="http://msdn.microsoft.com/en-us/library/ms968497.aspx">http://msdn.microsoft.com/en-us/library/ms968497.aspx</a><br>
<br>
Signing and Marking ActiveX Controls<br>
<a  href="http://msdn.microsoft.com/en-us/library/ms974305.aspx">http://msdn.microsoft.com/en-us/library/ms974305.aspx</a><br>
<br>
A Complete ActiveX Web Control Tutorial<br>
<a  href="http://www.codeproject.com/KB/COM/CompleteActiveX.aspx">http://www.codeproject.com/KB/COM/CompleteActiveX.aspx</a><br>
<br>
Packaging ActiveX Controls<br>
<a  href="http://msdn.microsoft.com/en-us/library/aa751974.aspx">http://msdn.microsoft.com/en-us/library/aa751974.aspx</a><br>
<br>
<br>
</p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img src="description/6a244f64-ef00-4481-b6a4-ee49b0a4a506image.png">
</a></div>

</div>


    </div>
</body>
</html>
