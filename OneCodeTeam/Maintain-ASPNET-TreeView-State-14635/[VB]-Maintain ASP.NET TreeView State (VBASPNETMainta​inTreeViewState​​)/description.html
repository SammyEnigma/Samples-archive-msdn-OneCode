<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/1c1e217c-1475-400e-91a7-b2be1bd6efa0Combined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Maintain ASP.NET TreeView State (VBASPNETMainta​inTreeViewState​​)</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Maintain ASP.NET TreeView State (VBASPNETMainta​inTreeViewState​​)</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            ASP.NET
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            TreeView
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Web
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">12/28/2011</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MS-LPL</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/VBASPNETMaintainTreeViewSta-01591ffc">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Maintain ASP.NET TreeView State (VBASPNETMaintainTreeViewState)</h1>
<h2>Summary</h2>
<p>The code-sample illustrates how to maintain TreeView's state across postbacks.&nbsp; The web application use session store the TreeView nodes' status and restore them in the next postback event. This interesting function can be used as the signs of the navigator
 bar.</p>
<h2>Demo</h2>
<p>Please follow these demonstration steps below.</p>
<p>Step 1: Open the VBASPNETMaintainTreeViewState.sln.</p>
<p>Step 2: Expand the VBASPNETMaintainTreeViewState web application and press&nbsp;Ctrl &#43; F5 to show the TreeViewPage.aspx.</p>
<p>Step 3: You will see an TreeView control on the page, please operate the TreeView's nodes and Click the Save TreeView state button.&nbsp;</p>
<p>Step 4: Click the Refresh This Page button to invoke the post back event.&nbsp; You can find the TreeView's state will stay the same.</p>
<p>Step 5: You can also click the refresh button of Browsers, the TreeView state can still be maintained.</p>
<h2>Code Logical</h2>
<p>Step 1. Create a VB &quot;ASP.NET Empty Web Application&quot; in Visual Studio 2010 or&nbsp;Visual Web Developer 2010. Name it as &quot;VBASPNETMaintainTreeViewState&quot;.</p>
<p>Step 2. Add one web form in the root directory, name it as &quot;TreeViewPage.aspx&quot;.</p>
<p>Step 3. Add a TreeView control and two buttons on the page, you can add some nodes of TreeView manually.<br>
&nbsp;&nbsp;<br>
Step 4&nbsp; Create App_Code folder and add TreeViewState class file, This class use to handler TreeView nodes status and restore them:</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">        ''' &lt;summary&gt;
        ''' Store TreeView's state in a session.
        ''' &lt;/summary&gt;
        ''' &lt;param name=&quot;treeView&quot;&gt;&lt;/param&gt;
        ''' &lt;param name=&quot;key&quot;&gt;&lt;/param&gt;
        ''' &lt;param name=&quot;context&quot;&gt;&lt;/param&gt;
        Public Sub SaveTreeView(ByVal treeView As TreeView, ByVal key As String, ByVal context As HttpContext)
            context.Session(key) = treeView.Nodes
        End Sub

        ''' &lt;summary&gt;
        ''' Restore TreeView's state from session variable, and invoke SaveTreeView method.
        ''' &lt;/summary&gt;
        ''' &lt;param name=&quot;treeView&quot;&gt;&lt;/param&gt;
        ''' &lt;param name=&quot;key&quot;&gt;&lt;/param&gt;
        ''' &lt;param name=&quot;context&quot;&gt;&lt;/param&gt;
        Public Sub RestoreTreeView(ByVal treeView As TreeView, ByVal key As String, ByVal context As HttpContext)
            If New TreeViewState(key).IsSaved Then
                treeView.Nodes.Clear()

                Dim nodes As TreeNodeCollection = DirectCast(context.Session(key), TreeNodeCollection)
                For index As Integer = nodes.Count - 1 To 0 Step -1
                    treeView.Nodes.AddAt(0, nodes(index))
                Next
                Me.SaveTreeView(treeView, key, context)
            End If

        End Sub</pre>
<div class="preview">
<pre class="csharp"><span class="cs__string">''</span>'&nbsp;&lt;summary&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span><span class="cs__string">'&nbsp;Store&nbsp;TreeView'</span>s&nbsp;state&nbsp;<span class="cs__keyword">in</span>&nbsp;a&nbsp;session.&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;/summary&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;param&nbsp;name=<span class="cs__string">&quot;treeView&quot;</span>&gt;&lt;/param&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;param&nbsp;name=<span class="cs__string">&quot;key&quot;</span>&gt;&lt;/param&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;param&nbsp;name=<span class="cs__string">&quot;context&quot;</span>&gt;&lt;/param&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Public&nbsp;Sub&nbsp;SaveTreeView(ByVal&nbsp;treeView&nbsp;As&nbsp;TreeView,&nbsp;ByVal&nbsp;key&nbsp;As&nbsp;String,&nbsp;ByVal&nbsp;context&nbsp;As&nbsp;HttpContext)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.Session(key)&nbsp;=&nbsp;treeView.Nodes&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;Sub&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;summary&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span><span class="cs__string">'&nbsp;Restore&nbsp;TreeView'</span>s&nbsp;state&nbsp;from&nbsp;session&nbsp;variable,&nbsp;and&nbsp;invoke&nbsp;SaveTreeView&nbsp;method.&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;/summary&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;param&nbsp;name=<span class="cs__string">&quot;treeView&quot;</span>&gt;&lt;/param&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;param&nbsp;name=<span class="cs__string">&quot;key&quot;</span>&gt;&lt;/param&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;param&nbsp;name=<span class="cs__string">&quot;context&quot;</span>&gt;&lt;/param&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Public&nbsp;Sub&nbsp;RestoreTreeView(ByVal&nbsp;treeView&nbsp;As&nbsp;TreeView,&nbsp;ByVal&nbsp;key&nbsp;As&nbsp;String,&nbsp;ByVal&nbsp;context&nbsp;As&nbsp;HttpContext)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;New&nbsp;TreeViewState(key).IsSaved&nbsp;Then&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;treeView.Nodes.Clear()&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dim&nbsp;nodes&nbsp;As&nbsp;TreeNodeCollection&nbsp;=&nbsp;DirectCast(context.Session(key),&nbsp;TreeNodeCollection)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;For&nbsp;index&nbsp;As&nbsp;Integer&nbsp;=&nbsp;nodes.Count&nbsp;-&nbsp;<span class="cs__number">1</span>&nbsp;To&nbsp;<span class="cs__number">0</span>&nbsp;Step&nbsp;-<span class="cs__number">1</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;treeView.Nodes.AddAt(<span class="cs__number">0</span>,&nbsp;nodes(index))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Next&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Me.SaveTreeView(treeView,&nbsp;key,&nbsp;context)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;If&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;Sub</pre>
</div>
</div>
</div>
<div class="endscriptcode">Step 5. Add SaveTreeViewState button's OnClick event and TreeView data bind event code of TreeViewState.aspx.vb file below:</div>
<div class="endscriptcode">
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">    		''' &lt;summary&gt;
        ''' The method use to bind TreeView with node's last save state across postback.
        ''' &lt;/summary&gt;
        Private Sub TreeViewBind()
            If state.IsSaved Then
                state.RestoreTreeView(tvwNodes, &quot;TreeViewState&quot;, HttpContext.Current)
            End If
        End Sub

        ''' &lt;summary&gt;
        ''' The button click event use to save TreeView's state 
        ''' &lt;/summary&gt;
        ''' &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        ''' &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        Protected Sub btnSaveTreeViewState_Click(ByVal sender As Object, ByVal e As EventArgs)
            state.SaveTreeView(tvwNodes, &quot;TreeViewState&quot;, HttpContext.Current)
        End Sub</pre>
<div class="preview">
<pre class="csharp"><span class="cs__string">''</span>'&nbsp;&lt;summary&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span><span class="cs__string">'&nbsp;The&nbsp;method&nbsp;use&nbsp;to&nbsp;bind&nbsp;TreeView&nbsp;with&nbsp;node'</span>s&nbsp;last&nbsp;save&nbsp;state&nbsp;across&nbsp;postback.&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;/summary&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Private&nbsp;Sub&nbsp;TreeViewBind()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;state.IsSaved&nbsp;Then&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.RestoreTreeView(tvwNodes,&nbsp;<span class="cs__string">&quot;TreeViewState&quot;</span>,&nbsp;HttpContext.Current)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;If&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;Sub&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;summary&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span><span class="cs__string">'&nbsp;The&nbsp;button&nbsp;click&nbsp;event&nbsp;use&nbsp;to&nbsp;save&nbsp;TreeView'</span>s&nbsp;state&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;/summary&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;param&nbsp;name=<span class="cs__string">&quot;sender&quot;</span>&gt;&lt;/param&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__string">''</span>'&nbsp;&lt;param&nbsp;name=<span class="cs__string">&quot;e&quot;</span>&gt;&lt;/param&gt;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Protected&nbsp;Sub&nbsp;btnSaveTreeViewState_Click(ByVal&nbsp;sender&nbsp;As&nbsp;Object,&nbsp;ByVal&nbsp;e&nbsp;As&nbsp;EventArgs)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.SaveTreeView(tvwNodes,&nbsp;<span class="cs__string">&quot;TreeViewState&quot;</span>,&nbsp;HttpContext.Current)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;Sub</pre>
</div>
</div>
</div>
<div class="endscriptcode">Step 6. Build the application and you can debug it.</div>
</div>
<p>&nbsp;</p>
<h2>References:</h2>
<p>MSDN: TreeView Class<br>
<a href="http://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.treeview.aspx">http://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.treeview.aspx</a></p>
<p>MSDN: TreeNodeCollection Class<br>
<a href="http://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.treenodecollection.aspx">http://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.treenodecollection.aspx</a></p>
<p>&nbsp;</p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img src="description/f0ce43d4-e8ea-415f-bfdd-f6bb39d3f968image.png" alt=""></a></div>

</div>


    </div>
</body>
</html>
