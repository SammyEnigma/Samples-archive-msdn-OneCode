<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/67b74b86-a273-4ad7-9ed5-0f97276412eaCombined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Change AppPool identity programmatically (CSAzureChangeAppPoolIdentity)</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Change AppPool identity programmatically (CSAzureChangeAppPoolIdentity)</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Microsoft Azure
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            ApplicationPool
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Cloud
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">4/16/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MS-LPL</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/CSAzureChangeAppPoolIdentit-27099828">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<p style="font-family:Courier New">&nbsp;<a href="http://www.microsoft.com/click/services/Redirect2.ashx?CR_CC=200144420" ><img id="79969" src="description/120x90_Azure_web_EN_US.jpg" alt="" width="360" height="90"></a></p>
<h1>Change <span class="SpellE">AppPool</span> identity programmatically (<span class="SpellE">CSAzureChangeAppPoolIdentity</span>)</h1>
<h2>Introduction</h2>
<p class="MsoNormal"><span style="font-size:8.0pt; line-height:115%; font-family:&quot;Arial&quot;,&quot;sans-serif&quot;; color:#384b38">â€‹</span>Most of customers test their applications to connect to cloud entities like storage, SQL Azure,
<span class="SpellE">AppFabric</span> services via compute emulator environment. If the customer's machine is behind proxy that does not allow traffic from non-authenticated users, their connections fail. One of the workaround is to change the application
 identity. This cannot be done manually for Azure scenario since the app pool is created by Azure when it is actually running the service. Hence, I have written sample customers can use to change the
<span class="SpellE">AppPool</span> identity programmatically.</p>
<p class="MsoNormal" style="text-align:right"><a href="http://www.microsoft.com/click/services/Redirect2.ashx?CR_CC=200144420"><span style="color:windowtext; text-decoration:none"><span><img src="description/image.png" alt="" width="120" height="90" align="middle">
</span></span></a><br>
<a href="http://www.microsoft.com/click/services/Redirect2.ashx?CR_CC=200144420">Try Windows Azure for free for 90 Days!</a></p>
<h2>Building the Sample</h2>
<p class="MsoNormal">This sample needs to be configured with <span class="SpellE">
sitename</span>, domain user/password, before running it.</p>
<p class="MsoNormal"><span>Under <span class="SpellE"><span class="GramE">OnStart</span></span><span class="GramE">(</span>) Method, you will find three variables as mentioned below. These three variables needs to be configured by user before running
 the sample.</span></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-size:9.5pt; font-family:Consolas; color:green"><span>&nbsp; </span>
</span></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-size:9.5pt; font-family:Consolas">&nbsp;</span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">// Name of the site. Default name Azure gives to website is &quot;Web&quot;. If this is changed, 
// you would need to assign the name of the site to siteName variable. This can be 
// obtained from ServiceDefinition.def file.
var siteName = &quot;Web&quot;;


// Please change the domain\user to domain account that you would like to configure 
// for AppPool to run under
var userName = @&quot;Domain\user&quot;;  


// Password of the above specified domain user
var password = &quot;********&quot;; //***This must be changed 

</pre>
<pre id="codePreview" class="csharp">// Name of the site. Default name Azure gives to website is &quot;Web&quot;. If this is changed, 
// you would need to assign the name of the site to siteName variable. This can be 
// obtained from ServiceDefinition.def file.
var siteName = &quot;Web&quot;;


// Please change the domain\user to domain account that you would like to configure 
// for AppPool to run under
var userName = @&quot;Domain\user&quot;;  


// Password of the above specified domain user
var password = &quot;********&quot;; //***This must be changed 

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-size:9.5pt; font-family:Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="color:black">For non &ndash; Azure scenarios, one additional step is needed. Under
<span class="SpellE"><span class="GramE">OnStart</span></span><span class="GramE">(</span>) method , locate below line of code.
</span></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-size:9.5pt; font-family:Consolas">&nbsp;</span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">//Get the name of the appPool that is created by Azure
                appPoolName = serverManager.Sites[RoleEnvironment.CurrentRoleInstance.Id &#43; &quot;_&quot; &#43; siteName].Applications.First().ApplicationPoolName;

</pre>
<pre id="codePreview" class="csharp">//Get the name of the appPool that is created by Azure
                appPoolName = serverManager.Sites[RoleEnvironment.CurrentRoleInstance.Id &#43; &quot;_&quot; &#43; siteName].Applications.First().ApplicationPoolName;

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="color:black">&nbsp;</span></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="color:black">And change the above line to </span></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-size:9.5pt; font-family:Consolas">&nbsp;</span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">appPoolName = serverManager.Sites[siteName].Applications.First().ApplicationPoolName;

</pre>
<pre id="codePreview" class="csharp">appPoolName = serverManager.Sites[siteName].Applications.First().ApplicationPoolName;

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="color:black">&nbsp;</span></p>
<p class="MsoNormal">Configure the variables as mentioned in the &quot;Building the sample&quot; section and then run the sample by clicking F5 in VS or build the sample and run the exe. Once you confirm that the sample is working, take the code from
<span class="SpellE"><span class="GramE">OnStart</span></span><span class="GramE">(</span>) method and incorporate with actual application.</p>
<p class="MsoNormal">Add references to <span class="SpellE"><a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/Microsoft.Web.Administration.aspx"  title="Auto generated link to Microsoft.Web.Administration">Microsoft.Web.Administration</a></span> (location: &lt;<span class="SpellE">systemdrive</span>&gt;\system32\<span class="SpellE">inetsrv</span>),
<span class="SpellE"><a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.DirectoryServices.aspx"  title="Auto generated link to System.DirectoryServices">System.DirectoryServices</a></span> (Location: .Net framework installation directory) assemblies and add below using statements to your project.<span style="font-size:13.0pt; line-height:115%; font-family:&quot;Cambria&quot;,&quot;serif&quot;">
</span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">using <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/Microsoft.Web.Administration.aspx"  title="Auto generated link to Microsoft.Web.Administration">Microsoft.Web.Administration</a>;
using <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.DirectoryServices.aspx"  title="Auto generated link to System.DirectoryServices">System.DirectoryServices</a>;

</pre>
<pre id="codePreview" class="csharp">using <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/Microsoft.Web.Administration.aspx"  title="Auto generated link to Microsoft.Web.Administration">Microsoft.Web.Administration</a>;
using <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.DirectoryServices.aspx"  title="Auto generated link to System.DirectoryServices">System.DirectoryServices</a>;

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal">&nbsp;</p>
<p class="MsoNormal">Code that gets <span class="SpellE">AppPool</span> using given parameters and changes its identity to configured user.</p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-size:9.5pt; font-family:Consolas"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">// Name of the site. Default name Azure gives to website is &quot;Web&quot;. If this is changed, 
// you would need to assign the name of the site to siteName variable. This can be 
// obtained from ServiceDefinition.def file.
var siteName = &quot;Web&quot;;


// Please change the domain\user to domain account that you would like to configure 
// for AppPool to run under
var userName = @&quot;Domain\user&quot;;  


// Password of the above specified domain user
var password = &quot;********&quot;; //***This must be changed 


// This variable is used to iterate through list of Application pools
var metabasePath = &quot;IIS://localhost/W3SVC/AppPools&quot;;


// This variable is to get the name of AppPool that is created by Azure for current Azure service
var appPoolName = &quot;&quot;;




using (ServerManager serverManager = new ServerManager())
{
    //Get the name of the appPool that is created by Azure
    appPoolName = serverManager.Sites[RoleEnvironment.CurrentRoleInstance.Id &#43; &quot;_&quot; &#43; siteName].Applications.First().ApplicationPoolName;
}


// Get list of appPools at specified metabasePath location
using (DirectoryEntry appPools = new DirectoryEntry(metabasePath))
{
    // From the list of appPools, Search and get the appPool that is created by Azure 
    using (DirectoryEntry azureAppPool = appPools.Children.Find(appPoolName, &quot;IIsApplicationPool&quot;))
    {
        if (azureAppPool != null)
        {


            // Set the AppPoolIdentityType to 3. This is equalient to MD_APPPOOL_IDENTITY_TYPE_SPECIFICUSER -  
            // The application pool runs as a specified user account.
            // Refer to:
            // http://www.microsoft.com/technet/prodtechnol/WindowsServer2003/Library/IIS/e3a60d16-1f4d-44a4-9866-5aded450956f.mspx?mfr=true, 
            // http://learn.iis.net/page.aspx/624/application-pool-identities/ 
            // for more info on AppPoolIdentityType
            azureAppPool.InvokeSet(&quot;AppPoolIdentityType&quot;, new Object[] { 3 });
            
            // Configure username for the AppPool with above specified username                      
            azureAppPool.InvokeSet(&quot;WAMUserName&quot;, new Object[] { userName });
            
            // Configure password for the AppPool with above specified password                      
            azureAppPool.InvokeSet(&quot;WAMUserPass&quot;, new Object[] { password });
            
            // Write above settings to IIS metabase
            azureAppPool.Invoke(&quot;SetInfo&quot;, null);
            
            // Commit the above configuration changes that are written to metabase
            azureAppPool.CommitChanges();
        }


    }
    
    return base.OnStart();
}

</pre>
<pre id="codePreview" class="csharp">// Name of the site. Default name Azure gives to website is &quot;Web&quot;. If this is changed, 
// you would need to assign the name of the site to siteName variable. This can be 
// obtained from ServiceDefinition.def file.
var siteName = &quot;Web&quot;;


// Please change the domain\user to domain account that you would like to configure 
// for AppPool to run under
var userName = @&quot;Domain\user&quot;;  


// Password of the above specified domain user
var password = &quot;********&quot;; //***This must be changed 


// This variable is used to iterate through list of Application pools
var metabasePath = &quot;IIS://localhost/W3SVC/AppPools&quot;;


// This variable is to get the name of AppPool that is created by Azure for current Azure service
var appPoolName = &quot;&quot;;




using (ServerManager serverManager = new ServerManager())
{
    //Get the name of the appPool that is created by Azure
    appPoolName = serverManager.Sites[RoleEnvironment.CurrentRoleInstance.Id &#43; &quot;_&quot; &#43; siteName].Applications.First().ApplicationPoolName;
}


// Get list of appPools at specified metabasePath location
using (DirectoryEntry appPools = new DirectoryEntry(metabasePath))
{
    // From the list of appPools, Search and get the appPool that is created by Azure 
    using (DirectoryEntry azureAppPool = appPools.Children.Find(appPoolName, &quot;IIsApplicationPool&quot;))
    {
        if (azureAppPool != null)
        {


            // Set the AppPoolIdentityType to 3. This is equalient to MD_APPPOOL_IDENTITY_TYPE_SPECIFICUSER -  
            // The application pool runs as a specified user account.
            // Refer to:
            // http://www.microsoft.com/technet/prodtechnol/WindowsServer2003/Library/IIS/e3a60d16-1f4d-44a4-9866-5aded450956f.mspx?mfr=true, 
            // http://learn.iis.net/page.aspx/624/application-pool-identities/ 
            // for more info on AppPoolIdentityType
            azureAppPool.InvokeSet(&quot;AppPoolIdentityType&quot;, new Object[] { 3 });
            
            // Configure username for the AppPool with above specified username                      
            azureAppPool.InvokeSet(&quot;WAMUserName&quot;, new Object[] { userName });
            
            // Configure password for the AppPool with above specified password                      
            azureAppPool.InvokeSet(&quot;WAMUserPass&quot;, new Object[] { password });
            
            // Write above settings to IIS metabase
            azureAppPool.Invoke(&quot;SetInfo&quot;, null);
            
            // Commit the above configuration changes that are written to metabase
            azureAppPool.CommitChanges();
        }


    }
    
    return base.OnStart();
}

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p><a name="OLE_LINK1"><span>&nbsp;</span></a></p>
<p class="MsoNormal">&nbsp;</p>
<p class="MsoNormal">For more information on <span class="SpellE">AppPoolIdentityTypes</span> refer to</p>
<p class="MsoListParagraphCxSpFirst" style="text-indent:-.25in"><span style="font-family:Symbol"><span>&bull;<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><a href="http://www.microsoft.com/technet/prodtechnol/WindowsServer2003/Library/IIS/e3a60d16-1f4d-44a4-9866-5aded450956f.mspx?mfr=true"><span class="SpellE">AppPoolIdentityType</span>
<span class="SpellE">Metabase</span> Property (IIS 6.0)</a></p>
<p class="MsoListParagraphCxSpLast" style="text-indent:-.25in"><span style="font-family:Symbol"><span>&bull;<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="color:green"><a href="http://learn.iis.net/page.aspx/624/application-pool-identities">Application Pool Identities<span>&nbsp;
</span></a><span>&nbsp;</span></span></p>
<p class="MsoNormal" style="margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-size:9.5pt; font-family:Consolas; color:green">&nbsp;</span></p>
<p class="MsoNormal">&nbsp;</p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img src="description/95e3bc78-76ea-4f7c-8b0e-445ca740f249image.png" alt="">
</a></div>

</div>


    </div>
</body>
</html>
