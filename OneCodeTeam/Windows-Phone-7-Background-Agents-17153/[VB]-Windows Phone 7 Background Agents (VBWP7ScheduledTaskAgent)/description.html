<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/1c1e217c-1475-400e-91a7-b2be1bd6efa0Combined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Windows Phone 7 Background Agents (VBWP7ScheduledTaskAgent)</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Windows Phone 7 Background Agents (VBWP7ScheduledTaskAgent)</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Windows Phone 7, Windows Phone 7.5
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Background Agent
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Phone
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">8/22/2012</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/VBWP7ScheduledTaskAgent-a6f76c28">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Windows Phone 7 Scheduled Task Agent (VBWP7ScheduledTaskAgent)</h1>
<h2>Introduction</h2>
<p class="MsoNormal">This code sample demonstrates how to use Scheduled Task in Windows Phone 7.<span>&nbsp;
</span>It covers three parts:</p>
<p class="MsoListParagraphCxSpFirst" style="text-indent:-.25in"><span><span>1.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span>How to create a scheduled task.</p>
<p class="MsoListParagraphCxSpMiddle" style="text-indent:-.25in"><span><span>2.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span>How to catch the various errors thrown by scheduled task.</p>
<p class="MsoListParagraphCxSpLast" style="text-indent:-.25in"><span><span>3.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span>How to set the process safe by class Mutex.</p>
<h2>Building the Sample</h2>
<p class="MsoNormal">This sample should be opened with Windows phone Emulator, please download the latest version of
<a href="http://www.microsoft.com/download/en/details.aspx?id=27570">Windows Phone SDK 7.1</a>.</p>
<h2>Running the Sample</h2>
<p class="MsoNormal">1. Open the VBWP7ScheduledTaskAgent.sln file with Visual Studio.</p>
<p class="MsoNormal">2. Press Ctrl&#43;F5 to run the sample.<span>&nbsp; </span>You will find a Windows phone 7 Application on the page:</p>
<p class="MsoNormal"><span><img src="description/image.png" alt="" width="339" height="508" align="middle">
</span></p>
<p class="MsoNormal">3. Click the button to open or turn off the task.</p>
<p class="MsoNormal">4. Press the back button and wait for the background task show:</p>
<p class="MsoNormal"><span><img src="description/22e2e777-d9ae-45b1-b2d0-f7c7724ab19cimage.png" alt="" width="93" height="85" align="middle">
</span></p>
<p class="MsoNormal"><span><img src="description/2c98caba-b3f6-4fc1-a839-db44ee8199e5image.png" alt="" width="317" height="182" align="middle">
</span></p>
<p class="MsoNormal">&nbsp;</p>
<h2>Using the Code</h2>
<p class="MsoNormal"><strong>1. </strong>Create a Windows Phone Scheduled Task Agent project:</p>
<p class="MsoNormal"><span><img src="description/97c9bc4f-7406-445e-bf15-c6d7345dfdb4image.png" alt="" width="655" height="348" align="middle">
</span></p>
<p class="MsoNormal"><strong>2. </strong>Add the code:<span style="font-size:10.0pt; line-height:115%; font-family:&quot;Courier New&quot;">
</span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">vb</span>
<pre class="hidden">Protected Overrides Sub OnInvoke(Task As ScheduledTask)


    If Task.Name = &quot;PeriodicTaskDemo&quot; Then
        Dim toast As New ShellToast()
        Dim mutex As New <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Threading.Mutex.aspx"  title="Auto generated link to System.Threading.Mutex">System.Threading.Mutex</a>(True, &quot;ScheduledAgentData&quot;)
        mutex.WaitOne()
        Dim setting As IsolatedStorageSettings = IsolatedStorageSettings.ApplicationSettings
        toast.Title = setting(&quot;ScheduledAgentData&quot;).ToString()
        mutex.ReleaseMutex()
        toast.Content = &quot;Task Running&quot;
        toast.Show()
    End If
    ScheduledActionService.LaunchForTest(Task.Name, TimeSpan.FromSeconds(3))
    NotifyComplete()


End Sub

</pre>
<pre id="codePreview" class="vb">Protected Overrides Sub OnInvoke(Task As ScheduledTask)


    If Task.Name = &quot;PeriodicTaskDemo&quot; Then
        Dim toast As New ShellToast()
        Dim mutex As New <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Threading.Mutex.aspx"  title="Auto generated link to System.Threading.Mutex">System.Threading.Mutex</a>(True, &quot;ScheduledAgentData&quot;)
        mutex.WaitOne()
        Dim setting As IsolatedStorageSettings = IsolatedStorageSettings.ApplicationSettings
        toast.Title = setting(&quot;ScheduledAgentData&quot;).ToString()
        mutex.ReleaseMutex()
        toast.Content = &quot;Task Running&quot;
        toast.Show()
    End If
    ScheduledActionService.LaunchForTest(Task.Name, TimeSpan.FromSeconds(3))
    NotifyComplete()


End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal"><span>&nbsp;</span></p>
<p class="MsoNormal">ScheduledActionService provides the <a href="http://msdn.microsoft.com/en-us/library/microsoft.phone.scheduler.scheduledactionservice.launchfortest(v=vs.92).aspx">
LaunchForTest</a> method.<span>&nbsp; </span>Use this method during application development to test your background agent implementation. Background agents are launched by the operating system according to the type of agent and the current state of the system.
 This scheduling logic is described in Background Agents Overview for Windows Phone. You can use this method to launch an agent more frequently from your foreground application or from the agent itself in order to test the agent execution. This method should
 only be used during development. You should remove calls to this method from your production application.</p>
<p class="MsoNormal"><strong>3. </strong>Add the two button to open and turn off the task:</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>XAML</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">xaml</span>
<pre class="hidden">&lt;StackPanel Orientation=&quot;Vertical&quot; x:Name=&quot;ContentPanel&quot; Grid.Row=&quot;1&quot; Margin=&quot;12,0,12,0&quot;&gt;
    &lt;Button Content=&quot;Open Task&quot; Height=&quot;72&quot; Name=&quot;StartTask&quot; Width=&quot;200&quot; Click=&quot;StartPeriodicTask_Click&quot;/&gt;
    &lt;Button Content=&quot;Turn Off Task&quot; Height=&quot;72&quot; Name=&quot;StopTask&quot; Width=&quot;200&quot; Click=&quot;StopPeriodicTask_Click&quot;/&gt;
&lt;/StackPanel&gt;

</pre>
<pre id="codePreview" class="xaml">&lt;StackPanel Orientation=&quot;Vertical&quot; x:Name=&quot;ContentPanel&quot; Grid.Row=&quot;1&quot; Margin=&quot;12,0,12,0&quot;&gt;
    &lt;Button Content=&quot;Open Task&quot; Height=&quot;72&quot; Name=&quot;StartTask&quot; Width=&quot;200&quot; Click=&quot;StartPeriodicTask_Click&quot;/&gt;
    &lt;Button Content=&quot;Turn Off Task&quot; Height=&quot;72&quot; Name=&quot;StopTask&quot; Width=&quot;200&quot; Click=&quot;StopPeriodicTask_Click&quot;/&gt;
&lt;/StackPanel&gt;

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal"><span style="font-size:10.0pt; line-height:115%; font-family:&quot;Courier New&quot;">&nbsp;</span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">vb</span>
<pre class="hidden">Private Sub StartPeriodicTask()
    Dim periodicTask As New PeriodicTask(&quot;PeriodicTaskDemo&quot;)
    periodicTask.Description = &quot;Are presenting a periodic task&quot;
    Try
        ScheduledActionService.Add(periodicTask)
        ScheduledActionService.LaunchForTest(&quot;PeriodicTaskDemo&quot;, TimeSpan.FromSeconds(3))
        MessageBox.Show(&quot;Open the background agent success&quot;)
    Catch exception As InvalidOperationException
        If exception.Message.Contains(&quot;exists already&quot;) Then
            MessageBox.Show(&quot;Since then the background agent success is already running&quot;)
        End If
        If exception.Message.Contains(&quot;BNS Error: The action is disabled&quot;) Then
            MessageBox.Show(&quot;Background processes for this application has been prohibited&quot;)
        End If
        If exception.Message.Contains(&quot;BNS Error: The maximum number of ScheduledActions of this type have already been added.&quot;) Then
            MessageBox.Show(&quot;You open the daemon has exceeded the hardware limitations&quot;)
        End If


    Catch generatedExceptionName As SchedulerServiceException
    End Try
End Sub
Private Sub StopPeriodicTask()
    Try
        ScheduledActionService.Remove(&quot;PeriodicTaskDemo&quot;)
        MessageBox.Show(&quot;Turn off the background agent successfully&quot;)
    Catch exception As InvalidOperationException
        If exception.Message.Contains(&quot;doesn't exist&quot;) Then
            MessageBox.Show(&quot;Since then the background agent success is not running&quot;)
        End If


    Catch generatedExceptionName As SchedulerServiceException
    End Try
End Sub
Private Sub StartPeriodicTask_Click(sender As Object, e As RoutedEventArgs)
    StartPeriodicTask()
    SetData()
End Sub
Private Sub StopPeriodicTask_Click(sender As Object, e As RoutedEventArgs)
    StopPeriodicTask()
End Sub
Public Sub SetData()
    Dim mutex As New <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Threading.Mutex.aspx"  title="Auto generated link to System.Threading.Mutex">System.Threading.Mutex</a>(False, &quot;ScheduledAgentData&quot;)
    mutex.WaitOne()
    Dim setting As IsolatedStorageSettings = IsolatedStorageSettings.ApplicationSettings
    If Not setting.Contains(&quot;ScheduledAgentData&quot;) Then
        setting.Add(&quot;ScheduledAgentData&quot;, &quot;Foreground data&quot;)
    End If
    mutex.ReleaseMutex()
End Sub

</pre>
<pre id="codePreview" class="vb">Private Sub StartPeriodicTask()
    Dim periodicTask As New PeriodicTask(&quot;PeriodicTaskDemo&quot;)
    periodicTask.Description = &quot;Are presenting a periodic task&quot;
    Try
        ScheduledActionService.Add(periodicTask)
        ScheduledActionService.LaunchForTest(&quot;PeriodicTaskDemo&quot;, TimeSpan.FromSeconds(3))
        MessageBox.Show(&quot;Open the background agent success&quot;)
    Catch exception As InvalidOperationException
        If exception.Message.Contains(&quot;exists already&quot;) Then
            MessageBox.Show(&quot;Since then the background agent success is already running&quot;)
        End If
        If exception.Message.Contains(&quot;BNS Error: The action is disabled&quot;) Then
            MessageBox.Show(&quot;Background processes for this application has been prohibited&quot;)
        End If
        If exception.Message.Contains(&quot;BNS Error: The maximum number of ScheduledActions of this type have already been added.&quot;) Then
            MessageBox.Show(&quot;You open the daemon has exceeded the hardware limitations&quot;)
        End If


    Catch generatedExceptionName As SchedulerServiceException
    End Try
End Sub
Private Sub StopPeriodicTask()
    Try
        ScheduledActionService.Remove(&quot;PeriodicTaskDemo&quot;)
        MessageBox.Show(&quot;Turn off the background agent successfully&quot;)
    Catch exception As InvalidOperationException
        If exception.Message.Contains(&quot;doesn't exist&quot;) Then
            MessageBox.Show(&quot;Since then the background agent success is not running&quot;)
        End If


    Catch generatedExceptionName As SchedulerServiceException
    End Try
End Sub
Private Sub StartPeriodicTask_Click(sender As Object, e As RoutedEventArgs)
    StartPeriodicTask()
    SetData()
End Sub
Private Sub StopPeriodicTask_Click(sender As Object, e As RoutedEventArgs)
    StopPeriodicTask()
End Sub
Public Sub SetData()
    Dim mutex As New <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Threading.Mutex.aspx"  title="Auto generated link to System.Threading.Mutex">System.Threading.Mutex</a>(False, &quot;ScheduledAgentData&quot;)
    mutex.WaitOne()
    Dim setting As IsolatedStorageSettings = IsolatedStorageSettings.ApplicationSettings
    If Not setting.Contains(&quot;ScheduledAgentData&quot;) Then
        setting.Add(&quot;ScheduledAgentData&quot;, &quot;Foreground data&quot;)
    End If
    mutex.ReleaseMutex()
End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal">&nbsp;</p>
<h2>More Information</h2>
<p class="MsoNormal"><span><a href="http://msdn.microsoft.com/en-us/library/hh202942%28v=VS.92%29.aspx">Background Agents Overview for Windows Phone</a>
</span></p>
<p class="MsoNormal"><span><a href="http://msdn.microsoft.com/en-us/library/hh202944(v=vs.92).aspx">Background Agent Best Practices for Windows Phone</a>
</span></p>
<p class="MsoNormal">&nbsp;</p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img src="description/f0ce43d4-e8ea-415f-bfdd-f6bb39d3f968image.png" alt="">
</a></div>

</div>


    </div>
</body>
</html>
