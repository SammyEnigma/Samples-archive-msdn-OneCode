# In-process ATL COM server (ATLDllCOMServer)
## Requires
* Visual Studio 2010
## License
* MS-LPL
## Technologies
* COM
* Windows SDK
## Topics
* in-process COM Server
## IsPublished
* False
## ModifiedDate
* 2012-03-01 09:55:27
## Description

<h2><span style="font-size:14.0pt; line-height:115%">ACTIVE TEMPLATE LIBRARY </span>
<span style="font-size:14.0pt; line-height:115%">(</span><span style="font-size:14.0pt; line-height:115%">ATLDllCOMServer</span><span style="font-size:14.0pt; line-height:115%">)
</span></h2>
<h2>Introduction</h2>
<p class="MsoNormal">The ATLDllCOMServer sample demonstrates how to use Acitve Template Library (ATL) wizards in Visual Studio 2008 to generate an in-process COM server. ATL is designed to simplify the process of creating efficient, flexible, lightweight
 COM components. ATLDllCOMServer exposes an ATL STA simple object with properties, methods, and events:<span style="">
</span></p>
<p class="MsoNormal"><span style=""><span style="">&nbsp; </span>Program ID: <span class="SpellE">
ATLDllCOMServer.SimpleObject</span> </span></p>
<p class="MsoNormal"><span style=""><span style="">&nbsp; </span>CLSID_SimpleObject: 92FCF37F-F6C7-4F8A-AA09-1A14BA118084
</span></p>
<p class="MsoNormal"><span style=""><span style="">&nbsp; </span>IID_ISimpleObject: 830F85D0-91B9-406D-A273-BC33133DD44B
</span></p>
<p class="MsoNormal"><span style=""><span style="">&nbsp; </span>DIID__ISimpleObjectEvents: 87AD6FBC-8735-407C-9758-C80B48C78E7C
</span></p>
<p class="MsoNormal"><span style=""><span style="">&nbsp; </span>LIBID_ATLDllCOMServerLib: 9B23EFED-A0C1-46B6-A903-218206447F3E
</span></p>
<p class="MsoNormal"><span style=""><span style="">&nbsp; </span><span class="SpellE">AppID</span>: 9DD18FED-55F6-4741-AF25-798B90C4AED5
</span></p>
<h2><span style="">Using the code<span style="">&nbsp; </span></span></h2>
<h3><span style="">Properties: </span></h3>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C&#43;&#43;</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">cplusplus</span>
<pre class="hidden">
// With both get and put accessor methods
FLOAT FloatProperty 

</pre>
<pre id="codePreview" class="cplusplus">
// With both get and put accessor methods
FLOAT FloatProperty 

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<h3><span style=""><span style="">&nbsp; </span>Methods: </span></h3>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C&#43;&#43;</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">cplusplus</span>
<pre class="hidden">
// HelloWorld returns a BSTR &quot;HelloWorld&quot;
HRESULT HelloWorld([out,retval] BSTR* pRet);
// GetProcessThreadID outputs the running process ID and thread ID
HRESULT GetProcessThreadID([out] LONG* pdwProcessId, [out] LONG* pdwThreadId);

</pre>
<pre id="codePreview" class="cplusplus">
// HelloWorld returns a BSTR &quot;HelloWorld&quot;
HRESULT HelloWorld([out,retval] BSTR* pRet);
// GetProcessThreadID outputs the running process ID and thread ID
HRESULT GetProcessThreadID([out] LONG* pdwProcessId, [out] LONG* pdwThreadId);

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<h3><span style=""><span style="">&nbsp; </span>Events: </span></h3>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C&#43;&#43;</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">cplusplus</span>
<pre class="hidden">
// FloatPropertyChanging is fired before new value is set to the 
// FloatProperty property. The [in, out] parameter Cancel allows the 
// client to cancel the change of FloatProperty.
void FloatPropertyChanging(
  [in] FLOAT NewValue, [in, out] VARIANT_BOOL* Cancel);

</pre>
<pre id="codePreview" class="cplusplus">
// FloatPropertyChanging is fired before new value is set to the 
// FloatProperty property. The [in, out] parameter Cancel allows the 
// client to cancel the change of FloatProperty.
void FloatPropertyChanging(
  [in] FLOAT NewValue, [in, out] VARIANT_BOOL* Cancel);

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal"><span style=""></span></p>
<p class="MsoNormal"><span style="">The majority of codes in the sample are generated by Visual Studio. You can find the detailed steps of creating such a COM server in the Creation section of this document.
</span></p>
<h3><span style="">Build: </span></h3>
<p class="MsoNormal"><span style="">To build ATLDllCOMServer, please run Visual Studio as administrator
<span class="GramE">because<span style="">&nbsp; </span>the</span> component needs to be registered into HKCR.
</span></p>
<p class="MsoNormal"><span style=""></span></p>
<h3><span style="">Deployment: </span></h3>
<p class="MsoNormal"><span style="">A. Setup </span></p>
<p class="MsoNormal"><span style="">Regsvr32.exe ATLDllCOMServer.dll </span></p>
<p class="MsoNormal"><span style="">B. Cleanup </span></p>
<p class="MsoNormal"><span style="">Regsvr32.exe /u ATLDllCOMServer.dll</span><span style="">&nbsp;
</span><span style=""></span></p>
<h3><span style="">Creation: </span></h3>
<p class="MsoNormal"><span style="">A. Creating the project </span></p>
<p class="MsoNormal"><span style="">Step1. Create a Visual C&#43;&#43; / ATL / ATL Project named
<span class="SpellE">ATLDllCOMServer</span> in Visual Studio 2008. </span></p>
<p class="MsoNormal"><span style="">Step2. In the page &quot;Application Settings&quot; of ATL Project Wizard, select the server type as Dynamic-link library (DLL), and allow merging of proxy/stub code.
</span></p>
<p class="MsoNormal"><span style="">B. Adding an ATL Simple Object </span></p>
<p class="MsoNormal"><span style="">Step1. In Solution Explorer, add a new ATL / ATL Simple Object class to the project.
</span></p>
<p class="MsoNormal"><span style="">Step2. In ATL Simple Object Wizard, specify the short name as
<span class="SpellE">SimpleObject</span>, and select the threading model as Apartment (corresponding to STA), select Interface as Dual that supports both
<span class="SpellE">IDispatch</span> (late binding) and <span class="SpellE">
vtable</span> binding (early binding). Last, select the Connection points check box. This creates the _ISimpleObjectEvents interface in the file ATLDllCOMServer.idl. The Connection
<span class="GramE">points</span> option is the prerequisite for the component to supporting events.
</span></p>
<p class="MsoNormal"><span style="">C. Adding Properties to the ATL Simple Object
</span></p>
<p class="MsoNormal"><span style="">Step1. In Class View, find the interface ISimpleObject.
<span class="GramE">Right-click it and select Add / Add Property in the menu.</span>
</span></p>
<p class="MsoNormal"><span style="">Step2. In the Add Property Wizard, specify the property type as FLOAT and set the property name as FloatProperty. Select both Get function and Put function.
<span class="SpellE">SimpleObject</span> therefore exposes FloatProperty with the
<span class="SpellE">get&amp;put</span> <span class="SpellE">accessormethods</span>:
<span class="SpellE">get_FloatProperty</span>, <span class="SpellE">put_FloatProperty</span>.
</span></p>
<p class="MsoNormal"><span style="">Step3. Add a float field, m_fField, to the class
<span class="SpellE">CSimpleObject</span>: </span></p>
<p class="MsoNormal"><span style=""><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class="GramE">protected</span>: </span></p>
<p class="MsoNormal"><span style="">Implement the get&amp;put accessor methods of
<span class="SpellE">FloatProperty</span> to access <span class="SpellE">m_fField</span>.
</span></p>
<p class="MsoNormal"><span style="">D. Adding Methods to the ATL Simple Object </span>
</p>
<p class="MsoNormal"><span style="">Step1. In Class View, find the interface ISimpleObject.
<span class="GramE">Right-click it and select Add / Add Method on the shortcut menu.</span>
</span></p>
<p class="MsoNormal"><span style="">Step2. In the Add Method Wizard, specify the method name as HelloWorld. Add a parameter whose parameter attributes = retval, parameter type = BSTR*, and parameter name =
<span class="SpellE">pRet.</span> </span></p>
<p class="MsoNormal"><span style="">Step3. Write the body of <span class="SpellE">
HelloWorld</span> as this: </span></p>
<p class="MsoNormal"><span style="">With the almost same steps, the method GetProcessThreadID is added to get the executing process ID and thread ID.
</span></p>
<p class="MsoNormal"><span style="">HRESULT <span class="GramE">GetProcessThreadID(</span>[out] LONG*
<span class="SpellE">pdwProcessId</span>, [out] LONG* <span class="SpellE">pdwThreadId</span>);
</span></p>
<p class="MsoNormal"><span style="">E. Adding Events to the ATL Simple Object </span>
</p>
<p class="MsoNormal"><span style="">The Connection <span class="GramE">points</span> option in B/Step2 is the prerequisite for the component to supporting events.
</span></p>
<p class="MsoNormal"><span style="">Step1. In Class View, expand ATLDllCOMServer /
<span class="SpellE">ATLDllCOMServerLib</span> to display _<span class="SpellE">ISimpleObjectEvents</span>.
</span></p>
<p class="MsoNormal"><span style="">Step2. Right-click _ISimpleObjectEvents. On the shortcut menu, click Add, and then click Add Method.
</span></p>
<p class="MsoNormal"><span style="">Step3. Select a Return Type of void, enter <span class="SpellE">
FloatPropertyChanging</span> in the Method name box, and add an [in] parameter FLOAT NewValue, and an [in, out<span class="GramE">]
<span style="">&nbsp;</span>parameter</span> VARIANT_BOOL* Cancel. After clicking Finish, _<span class="SpellE">ISimpleObjectEvents</span> dispinterface in the ATLDllCOMServer.idl file should look like this:
</span></p>
<p class="MsoNormal"><span style="">Step4. Generate the type library by rebuilding the project or by right-clicking the ATLDllCOMServer.idl file in Solution Explorer and clicking Compile on the shortcut menu. Please note: We must compile the IDL file BEFORE
 setting up a connection point. </span></p>
<p class="MsoNormal"><span style="">Step5. Use the Implement Connection Point Wizard to implement the Connection Point interface: In Class View, right-click the component's implementation class
<span class="SpellE">CSimpleObject</span>. On the shortcut menu, click Add, and then click Add Connection Point. Select _ISimpleObjectEvents from the Source Interfaces list and double-click it to add it to the Implement connection
<span class="GramE">points</span> column. Click Finish. A proxy class for the connection point will be generated (<span class="SpellE">ie</span>.
<span class="GramE">CProxy_ISimpleObjectEvents in this example) in the file _<span class="SpellE">ISimpleObjectEvents_CP.h</span>.</span> This also creates a function with the name Fire<span class="GramE">_[</span><span class="SpellE">eventname</span>]
 that can be called to raise events in the client. </span></p>
<p class="MsoNormal"><span style="">Step6. Fire the event in put_FloatProperty:
</span></p>
<p class="MsoNormal"><span style=""></span></p>
<h2>More Information</h2>
<p class="MsoNormal" style="margin-bottom:0cm; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-family:������"></span></p>
<p class="MsoListParagraphCxSpFirst" style="margin-bottom:0cm; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-family:Symbol"><span style="">��<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="font-family:������"><a href="http://msdn.microsoft.com/en-us/library/599w5e7x.aspx">ATL Tutorial</a>
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-bottom:0cm; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-family:Symbol"><span style="">��<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="font-family:������"><a href="http://www.codeproject.com/KB/COM/nbd_ipc.aspx">An ATL Component in C&#43;&#43; that fires COM events By Neville Dastur</a>
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-bottom:0cm; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-family:Symbol"><span style="">��<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="font-family:������"><a href="http://support.microsoft.com/kb/194179">KB: AtlEvnt.exe sample shows how to creates ATL sinks by using the ATL IDispEventImpl and IDispEventSimpleImpl classes</a>
</span></p>
<p class="MsoListParagraphCxSpLast" style="margin-bottom:0cm; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style="font-family:Symbol"><span style="">��<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="font-family:������"><a href="http://support.microsoft.com/kb/976026/en-us">KB: How to develop an in-process COM component</a>
</span></p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img alt="" src="http://bit.ly/onecodelogo">
</a></div>
