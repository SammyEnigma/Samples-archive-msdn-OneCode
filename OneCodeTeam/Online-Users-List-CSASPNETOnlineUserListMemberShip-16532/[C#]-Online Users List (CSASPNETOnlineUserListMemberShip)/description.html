<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/67b74b86-a273-4ad7-9ed5-0f97276412eaCombined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Online Users List (CSASPNETOnlineUserListMemberShip)</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Online Users List (CSASPNETOnlineUserListMemberShip)</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            ASP.NET
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Session
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Web
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">4/20/2012</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MS-LPL</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/CSASPNETOnlineUserListMembe-67137e73">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    ======================================================================== CSASPNETOnlineUserListMemberShip Overview ======================================================================== /////////////////////////////////////////////////////////////////////////////
 Use: The project illustrates how to show an online user list via Membership. In many websites, managers want to collect statistics of online users, the sample can check if the user is online and his(her) last activity time, creation time and much useful information.
 ///////////////////////////////////////////////////////////////////////////// Demo the Sample. Please follow these demonstration steps below. Step 1: Open the CSASPNETOnlineUserListMemberShip.sln. Step 2: Expand the CSASPNETOnlineUserListMemberShip web application
 and press Ctrl &#43; F5 to show the OnlineUserList.aspx page. Step 3: You will see a GridView control on the page, please click &quot;User Register&quot; button go to RegisterUserInfo.aspx page. Step 4: Create some user accounts and return OnlineUserList.aspx page. Step
 5: You can find the new register users displayed in the list. You can make them log out or login. After 15 minutes without activity, the users will sign out automatically. Step 5: Validation finished. /////////////////////////////////////////////////////////////////////////////
 Code Logical: Step 1. Create a C# &quot;ASP.NET Empty Web Application&quot; in Visual Studio 2010 or Visual Web Developer 2010. Name it as &quot;CSASPNETOnlineUserListMemberShip&quot;. Step 2. Add two web forms and named them as &quot;OnlineUserList.aspx&quot;, &quot;RegisterUserInfo.aspx&quot;
 in root directory. Step 3. Create a class file named it as &quot;ValidateString.cs&quot;. Step 4. Add a GridView, two buttons, and some text on the OnlineUserList.aspx page. Managers can get all online users' name, last activity time, is online, etc on this page. They
 can also make users log out or login. GridView data bind event: [code] /// &lt;summary&gt; /// Re-bind GridView control with online users. /// &lt;/summary&gt; private void GridViewDataBind() { AllUsers = Membership.GetAllUsers(); foreach (MembershipUser user in AllUsers)
 { if (user.IsOnline) { OnlineUsers.Add(user); } } int OnlineUserCount = OnlineUsers.Count; lbMemberCount.Text = OnlineUserCount.ToString(); gvwOnlineUserList.DataSource = OnlineUsers; gvwOnlineUserList.DataBind(); } [/code] Step 5. Add log out and login events
 code like this: Login event: [code] /// &lt;summary&gt; /// Login users. /// &lt;/summary&gt; /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt; protected void btnLogin_Click(object sender, EventArgs e) { string userName = tbLoginUserName.Text.Trim(); string
 passWord = tbLoginPassWord.Text.Trim(); if (ValidateString.validateString(userName) && ValidateString.validateString(passWord)) { MembershipUser user = Membership.GetUser(userName); if (user != null) { if (user.IsOnline) { lbMessage.Text = &quot;The user have been
 logined.&quot;; return; } if (Membership.ValidateUser(userName, passWord)) { lbMessage.Text = &quot;Login successfully!&quot;; this.GridViewDataBind(); Response.Redirect(&quot;~/OnlineUserList.aspx&quot;); } else { lbMessage.Text = &quot;Login failed! Pass word or user name is incorrect&quot;;
 } } else { lbMessage.Text = &quot;Login failed! Can not find your user name.&quot;; } } else { lbMessage.Text = &quot;Please input your user name and pass word.&quot;; } } [/code] Log out event: [code] /// &lt;summary&gt; /// Log out specified user. /// &lt;/summary&gt; /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
 /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt; protected void gvwOnlineUserList_RowCommand(object sender, GridViewCommandEventArgs e) { if (e.CommandName == &quot;LogOutEvent&quot;) { int index = int.Parse(e.CommandArgument.ToString()); string userName = gvwOnlineUserList.Rows[index].Cells[0].Text;
 MembershipUser user = Membership.GetUser(userName); if (user != null) { Response.Cache.SetCacheability(HttpCacheability.NoCache); Response.Cache.SetExpires(DateTime.Now); user.LastActivityDate=DateTime.Now.AddYears(-1); Membership.UpdateUser(user); this.GridViewDataBind();
 } } } [/code] Step 6. Write validate methods in ValidateString.cs class file, this file use to validate e-mail string and normal string, you can find the these methods in sample's ValidateString.cs file. Step 7. Add user register method in RegisterUserInfo.aspx
 page like this: [code] MembershipCreateStatus status = new MembershipCreateStatus(); MembershipUser user = Membership.CreateUser(userName, passWord, userEmail, question, answer, true, out status); if (status == MembershipCreateStatus.Success) { AllUsers.Add(user);
 lbMessage.Text = &quot;Congratulations! Registration complete. Please go to OnlineUserList page.&quot;; } else { Response.Write(status.ToString()); } [/code] Step 8. Build the application and you can debug it. /////////////////////////////////////////////////////////////////////////////
 References: MSDN: Membership Class http://msdn.microsoft.com/en-us/library/system.web.security.membership.aspx MSDN: MembershipUser Class http://msdn.microsoft.com/en-us/library/system.web.security.membershipuser.aspx MSDN: MembershipUserCollection Class http://msdn.microsoft.com/en-us/library/system.web.security.membershipusercollection.aspx
 MSDN: MembershipUser.IsOnline Property http://msdn.microsoft.com/en-us/library/system.web.security.membershipuser.isonline.aspx MSDN: MembershipUser.LastActivityDate Property http://msdn.microsoft.com/en-us/library/system.web.security.membershipuser.lastactivitydate.aspx
 ///////////////////////////////////////////////////////////////////////////// 
</div>


    </div>
</body>
</html>
