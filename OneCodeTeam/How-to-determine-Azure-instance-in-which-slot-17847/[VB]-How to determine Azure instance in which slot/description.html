<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/1c1e217c-1475-400e-91a7-b2be1bd6efa0Combined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>How to determine Azure instance in which slot</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>How to determine Azure instance in which slot</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Microsoft Azure
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Staging
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Cloud
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">7/5/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/VBAzureDeploymentSlot-8f7873eb">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<p class="MsoNormal">To build this sample successfully, please make sure you have installed<span style=""> Windows Azure SDK 1.6.
</span></p>
<p class="MsoNormal">1. <span style="">Open the </span><span style="">VBAzureDeploymentSlot</span><span style="">.sln file with Visual Studio
</span>in elevated (administrator) mode<span style="">, and then you need to set </span>
<span class="SpellE"><span style="">VBAzureDeploymentSlot</span></span><span style="">
</span><span style="">Azure application as the startup application.</span><i style=""><span style="">
</span></i></p>
<p class="MsoNormal">2.<span style=""> </span>Before running the sample, you need to replace the following variables with your Azure application's information, such as subscription ID, hosted service name, etc.</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">vb</span>
<pre class="hidden">
Dim subscriptionID As String = &quot;&lt;Your subscription ID&gt;&quot;
Dim thrumbnail As String = &quot;&lt;Your certificate thumbnail print&gt;&quot;
Dim hostedServiceName As String = &quot;&lt;Your hosted service name&gt;&quot;

</pre>
<pre id="codePreview" class="vb">
Dim subscriptionID As String = &quot;&lt;Your subscription ID&gt;&quot;
Dim thrumbnail As String = &quot;&lt;Your certificate thumbnail print&gt;&quot;
Dim hostedServiceName As String = &quot;&lt;Your hosted service name&gt;&quot;

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="">3. You need to upload a server certificate in Azure Management Portal, and also need to add the same thumbnail print client certificate in Web role. Right Click your role =&gt; select &quot;Certificates&quot; =&gt; &quot;Add
 Certificate&quot;. </p>
<p class="MsoNormal" style="margin-bottom:0in; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
4. The sample code could not run on the local, because local <span class="SpellE">
deploymentID</span> is different with cloud <span class="SpellE">deploymentID</span>, local's ID like &quot;<span class="GramE">Deployment(</span>XXX)&quot;, but
<span class="SpellE">cloud'ID</span> is a GUID. So if you run the application in local, its display &quot;Do not find this id&quot;.
</p>
<p class="MsoNormal" style="margin-bottom:0in; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
</p>
<p class="MsoNormal" style="margin-bottom:0in; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
5. After deploying the application successfully, click the DNS name of the role, if your application is in
<span class="GramE">Staging</span> slot, it will display:</p>
<p class="MsoNormal" style="margin-bottom:0in; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
</p>
<p class="MsoNormal" style="margin-bottom:0in; margin-bottom:.0001pt; line-height:normal; text-autospace:none">
<span style=""><img src="description/image.png" alt="" width="583" height="533" align="middle">
</span><span style="font-size:9.5pt; font-family:新宋体; color:#A31515"></span></p>
<p class="MsoNormal" style=""><span style=""></span></p>
<p class="MsoNormal" style="">6. If your application is Production slot, it will display<span class="GramE">:<span style="">.</span></span><span style="">
</span></p>
<p class="MsoNormal" style=""><span style=""><img src="description/d3cc5d94-594d-4ede-9564-6bf44159ef9aimage.png" alt="" width="589" height="533" align="middle">
</span><span style=""></span></p>
<p class="MsoNormal" style="">7. <span style="">Validation finished </span></p>
<p class="MsoNormal" style=""><span style="">1</span>. <span style="">Create a Cloud Application Project in Visual Studio 2010, name it as &quot;</span><span style="">VBAzureDeploymentSlot</span><span style="">&quot;, please also create a Web Role application
 and name it as &quot;</span><span style="">VBAzureDeploymentSlot_WebRole</span><span style="">&quot;.
</span></p>
<p class="MsoNormal" style=""><span style="">2. </span>Delete all unnecessary files of the Web role application, and create a new Default web form page. Add a button control on this page, this page is used to send GET request to Azure management api to get
 deployment slot from Azure application. Please add the following code snippets in Default.aspx.vb file.<b><span style="font-size:12.0pt; line-height:115%; font-family:&quot;Cambria&quot;,&quot;serif&quot;">
</span></b></p>
<p class="MsoNormal" style=""><b><span style="font-size:12.0pt; line-height:115%; font-family:&quot;Cambria&quot;,&quot;serif&quot;">The following code shows</span></b><b><span style="font-size:12.0pt; line-height:115%; font-family:&quot;Cambria&quot;,&quot;serif&quot;"> how to determine Windows
 Azure application's current instance deployment slot: </span></b></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">vb</span>
<pre class="hidden">
Protected Sub Page_Load(ByVal sender As Object, ByVal e As <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.EventArgs.aspx"  title="Auto generated link to System.EventArgs">System.EventArgs</a>) Handles Me.Load
    ' You basic information of the Deployment of Azure application.
    Dim deploymentId As String = RoleEnvironment.DeploymentId
    Dim subscriptionID As String = &quot;&lt;Your subscription ID&gt;&quot;
    Dim thrumbnail As String = &quot;&lt;Your certificate thumbnail print&gt;&quot;
    Dim hostedServiceName As String = &quot;&lt;Your hosted service name&gt;&quot;
    Dim productionString As String = String.Format(&quot;https://management.core.windows.net/{0}/services/hostedservices/{1}/deploymentslots/{2}&quot;, subscriptionID, hostedServiceName, &quot;Production&quot;)
    Dim requestUri As New Uri(productionString)


    ' Add client certificate.
    Dim store As New X509Store(StoreName.My, StoreLocation.LocalMachine)
    store.Open(OpenFlags.OpenExistingOnly)
    Dim collection As X509Certificate2Collection = store.Certificates.Find(X509FindType.FindByThumbprint, thrumbnail, False)
    store.Close()


    If collection.Count &lt;&gt; 0 Then
        Dim certificate As X509Certificate2 = collection(0)
        Dim httpRequest As HttpWebRequest = DirectCast(HttpWebRequest.Create(requestUri), HttpWebRequest)
        httpRequest.ClientCertificates.Add(certificate)
        httpRequest.Headers.Add(&quot;x-ms-version&quot;, &quot;2011-10-01&quot;)
        httpRequest.KeepAlive = False
        Dim httpResponse As HttpWebResponse = TryCast(httpRequest.GetResponse(), HttpWebResponse)


        ' Get response stream from Management API.
        Dim stream As Stream = httpResponse.GetResponseStream()
        Dim result As String = String.Empty
        Using reader As New StreamReader(stream)


            result = reader.ReadToEnd()
        End Using
        If result Is Nothing OrElse result.Trim() = String.Empty Then
            Return
        End If
        Dim document As XDocument = XDocument.Parse(result)
        Dim serverID As String = String.Empty
        Dim list = From item In document.Descendants(XName.[Get](&quot;PrivateID&quot;, &quot;http://schemas.microsoft.com/windowsazure&quot;))
                   Select item


        serverID = list.First().Value
        Response.Write(&quot;Check Production: <br>&quot;)
        Response.Write(&quot;DeploymentID : &quot; & deploymentId & &quot;<br> ServerID :&quot; & serverID)
        If deploymentId.Equals(serverID) Then
            lbStatus.Text = &quot;Production&quot;
        Else
            ' If the application not in Production slot, try to check Staging slot.
            Dim stagingString As String = String.Format(&quot;https://management.core.windows.net/{0}/services/hostedservices/{1}/deploymentslots/{2}&quot;, subscriptionID, hostedServiceName, &quot;Staging&quot;)
            Dim stagingUri As New Uri(stagingString)
            httpRequest = DirectCast(HttpWebRequest.Create(stagingUri), HttpWebRequest)
            httpRequest.ClientCertificates.Add(certificate)
            httpRequest.Headers.Add(&quot;x-ms-version&quot;, &quot;2011-10-01&quot;)
            httpRequest.KeepAlive = False
            httpResponse = TryCast(httpRequest.GetResponse(), HttpWebResponse)
            stream = httpResponse.GetResponseStream()
            result = String.Empty
            Using reader As New StreamReader(stream)


                result = reader.ReadToEnd()
            End Using
            If result Is Nothing OrElse result.Trim() = String.Empty Then
                Return
            End If
            document = XDocument.Parse(result)
            serverID = String.Empty
            list = From item In document.Descendants(XName.[Get](&quot;PrivateID&quot;, &quot;http://schemas.microsoft.com/windowsazure&quot;))
                   Select item


            serverID = list.First().Value
            Response.Write(&quot;<br> Check Staging:&quot;)
            Response.Write(&quot;<br> DeploymentID : &quot; & deploymentId & &quot;<br> ServerID :&quot; & serverID)
            If deploymentId.Equals(serverID) Then
                lbStatus.Text = &quot;Staging&quot;
            Else
                lbStatus.Text = &quot;Do not find this id&quot;
            End If
        End If
        httpResponse.Close()
        stream.Close()
    End If
End Sub

</pre>
<pre id="codePreview" class="vb">
Protected Sub Page_Load(ByVal sender As Object, ByVal e As <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.EventArgs.aspx"  title="Auto generated link to System.EventArgs">System.EventArgs</a>) Handles Me.Load
    ' You basic information of the Deployment of Azure application.
    Dim deploymentId As String = RoleEnvironment.DeploymentId
    Dim subscriptionID As String = &quot;&lt;Your subscription ID&gt;&quot;
    Dim thrumbnail As String = &quot;&lt;Your certificate thumbnail print&gt;&quot;
    Dim hostedServiceName As String = &quot;&lt;Your hosted service name&gt;&quot;
    Dim productionString As String = String.Format(&quot;https://management.core.windows.net/{0}/services/hostedservices/{1}/deploymentslots/{2}&quot;, subscriptionID, hostedServiceName, &quot;Production&quot;)
    Dim requestUri As New Uri(productionString)


    ' Add client certificate.
    Dim store As New X509Store(StoreName.My, StoreLocation.LocalMachine)
    store.Open(OpenFlags.OpenExistingOnly)
    Dim collection As X509Certificate2Collection = store.Certificates.Find(X509FindType.FindByThumbprint, thrumbnail, False)
    store.Close()


    If collection.Count &lt;&gt; 0 Then
        Dim certificate As X509Certificate2 = collection(0)
        Dim httpRequest As HttpWebRequest = DirectCast(HttpWebRequest.Create(requestUri), HttpWebRequest)
        httpRequest.ClientCertificates.Add(certificate)
        httpRequest.Headers.Add(&quot;x-ms-version&quot;, &quot;2011-10-01&quot;)
        httpRequest.KeepAlive = False
        Dim httpResponse As HttpWebResponse = TryCast(httpRequest.GetResponse(), HttpWebResponse)


        ' Get response stream from Management API.
        Dim stream As Stream = httpResponse.GetResponseStream()
        Dim result As String = String.Empty
        Using reader As New StreamReader(stream)


            result = reader.ReadToEnd()
        End Using
        If result Is Nothing OrElse result.Trim() = String.Empty Then
            Return
        End If
        Dim document As XDocument = XDocument.Parse(result)
        Dim serverID As String = String.Empty
        Dim list = From item In document.Descendants(XName.[Get](&quot;PrivateID&quot;, &quot;http://schemas.microsoft.com/windowsazure&quot;))
                   Select item


        serverID = list.First().Value
        Response.Write(&quot;Check Production: <br>&quot;)
        Response.Write(&quot;DeploymentID : &quot; & deploymentId & &quot;<br> ServerID :&quot; & serverID)
        If deploymentId.Equals(serverID) Then
            lbStatus.Text = &quot;Production&quot;
        Else
            ' If the application not in Production slot, try to check Staging slot.
            Dim stagingString As String = String.Format(&quot;https://management.core.windows.net/{0}/services/hostedservices/{1}/deploymentslots/{2}&quot;, subscriptionID, hostedServiceName, &quot;Staging&quot;)
            Dim stagingUri As New Uri(stagingString)
            httpRequest = DirectCast(HttpWebRequest.Create(stagingUri), HttpWebRequest)
            httpRequest.ClientCertificates.Add(certificate)
            httpRequest.Headers.Add(&quot;x-ms-version&quot;, &quot;2011-10-01&quot;)
            httpRequest.KeepAlive = False
            httpResponse = TryCast(httpRequest.GetResponse(), HttpWebResponse)
            stream = httpResponse.GetResponseStream()
            result = String.Empty
            Using reader As New StreamReader(stream)


                result = reader.ReadToEnd()
            End Using
            If result Is Nothing OrElse result.Trim() = String.Empty Then
                Return
            End If
            document = XDocument.Parse(result)
            serverID = String.Empty
            list = From item In document.Descendants(XName.[Get](&quot;PrivateID&quot;, &quot;http://schemas.microsoft.com/windowsazure&quot;))
                   Select item


            serverID = list.First().Value
            Response.Write(&quot;<br> Check Staging:&quot;)
            Response.Write(&quot;<br> DeploymentID : &quot; & deploymentId & &quot;<br> ServerID :&quot; & serverID)
            If deploymentId.Equals(serverID) Then
                lbStatus.Text = &quot;Staging&quot;
            Else
                lbStatus.Text = &quot;Do not find this id&quot;
            End If
        End If
        httpResponse.Close()
        stream.Close()
    End If
End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal" style="">3. Build the application and you can debug it now.</p>
<p class="MsoNormal" style=""><a href="http://msdn.microsoft.com/en-us/library/windowsazure/ee460804.aspx">Get Deployment</a></p>
<p class="MsoNormal" style=""><span style=""><a href="http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleenvironment.deploymentid.aspx"><span class="SpellE">RoleEnvironment.DeploymentId</span> Property</a>
</span></p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img alt="" src="description/f0ce43d4-e8ea-415f-bfdd-f6bb39d3f968image.png">
</a></div>

</div>


    </div>
</body>
</html>
