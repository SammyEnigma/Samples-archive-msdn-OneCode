<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/67b74b86-a273-4ad7-9ed5-0f97276412eaCombined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Add registry entries to VMs in Windows Azure (CSAzureAddRegistryKeysToVMs)</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Add registry entries to VMs in Windows Azure (CSAzureAddRegistryKeysToVMs)</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Microsoft Azure
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Registry Key
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Cloud
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">4/16/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/CSAzureAddRegistryKeysToVMs-75edd269">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<p style="font-family:Courier New">&nbsp;<a href="http://www.microsoft.com/click/services/Redirect2.ashx?CR_CC=200144420" ><img id="79969" src="description/120x90_Azure_web_EN_US.jpg" alt="" width="360" height="90"></a></p>
<h1>Add registry entries to VM&rsquo;s running in Windows Azure (CSAzureAddRegistryKeysToVMs)</h1>
<h2>Introduction</h2>
<p>One of the common asks from developers is the ability to write to registry in Windows Azure. Startup tasks in Windows Azure can help you write to registry.&nbsp; This sample code will add the registry keys to Azure VM's.</p>
<div align="right">
<p><a href="http://www.microsoft.com/click/services/Redirect2.ashx?CR_CC=200144420"><span style="color:windowtext; text-decoration:none"><span><img src="description/image.png" alt="" width="120" height="90" align="middle">
</span></span></a><br>
<a href="http://www.microsoft.com/click/services/Redirect2.ashx?CR_CC=200144420">Try Windows Azure for free for 90 Days!</a></p>
</div>
<h2>Building the Sample</h2>
<p>This sample can be run as-is without making any changes to it.</p>
<h2>Running the Sample</h2>
<p>Open the sample on the machine where VS 2010, Windows Azure SDK 1.6 are installed.</p>
<p>Right click on the cloud service project i.e. CSAzureAddRegistryKeysToVMs and choose Publish.</p>
<p>Follow the steps in publish Wizard and choose subscription details, deployment slots, etc. and enable remote desktop for all roles.</p>
<p>After successful publish, login to Azure VM and verify that 3 registry keys(One for string, One for binary value, One for DWORD value) are created under HKEY_LOCAL_MACHINE\System\Test\Test1</p>
<h2>Using the Code</h2>
<p>1) Create sample.reg file with required registry entries. For testing purposes, I&rsquo;m using sample.reg file with below entries. In real world scenarios, you can create the registry file simply by exporting the section of registry settings you would like
 to add to Azure VM&rsquo;s.<br>
&nbsp;<br>
&nbsp;Windows Registry Editor Version 5.00 <br>
&nbsp;[HKEY_LOCAL_MACHINE\System\Test\Test1] <br>
&nbsp;&quot;New Binary Setting&quot;=hex:42,69,6e,61,72,79,20,56,61,6c,75,65 <br>
&nbsp;&quot;New DWORD Setting&quot;=dword:00000001 <br>
&nbsp;&quot;New String Setting&quot;=&quot;Something&quot;</p>
<p>This sample file adds values settings named &ldquo;New Binary Setting&rdquo;, &ldquo;New DWORD Setting&rdquo;, &ldquo;New String Setting&rdquo; and configures with above specified values.<br>
&nbsp;<br>
2) Add the sample.reg file to web role / worker role project as required.</p>
<p>3)&nbsp;Configure below file properties for sample.reg file , so that it will be copied to bin directory.</p>
<p>Build Action : Content&nbsp;<br>
Copy To Output Directory : Copy Always<br>
&nbsp;<br>
4)&nbsp;Create addreg.cmd file with below code.<br>
&nbsp;<br>
regedit /s sample.reg <br>
exit /b 0<br>
&nbsp;<br>
5) Add the addreg.cmd file to Web Role / Worker role as required.</p>
<p>6)&nbsp;Configure below file properties for addreg.cmd file, so that it will be copied to bin directory.<br>
&nbsp;<br>
Build Action : Content&nbsp;<br>
Copy To Output Directory : Copy Always<br>
&nbsp;<br>
7)&nbsp;Finally, define startup task in ServiceDefinition.csdef file by adding following block of configuration under &lt;Webrole&gt; / &lt;WorkerRole&gt; tag</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>XML</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">xml</span>
<pre class="hidden">&lt;Startup&gt;  
  &lt;Task commandLine=&quot;addreg.cmd&quot; executionContext=&quot;elevated&quot; taskType=&quot;simple&quot;&gt;  &lt;/Task&gt;  
&lt;/Startup&gt; 
</pre>
<div class="preview">
<pre class="xml"><span class="xml__tag_start">&lt;Startup</span><span class="xml__tag_start">&gt;&nbsp;</span><span class="xml__tag_start">&lt;Task</span><span class="xml__attr_name">commandLine</span>=<span class="xml__attr_value">&quot;addreg.cmd&quot;</span><span class="xml__attr_name">executionContext</span>=<span class="xml__attr_value">&quot;elevated&quot;</span><span class="xml__attr_name">taskType</span>=<span class="xml__attr_value">&quot;simple&quot;</span><span class="xml__tag_start">&gt;&nbsp;</span><span class="xml__tag_end">&lt;/Task&gt;</span><span class="xml__tag_end">&lt;/Startup&gt;</span></pre>
</div>
</div>
</div>
<div class="endscriptcode">8) Deploy the application to cloud and you should have &ldquo;New Binary Setting&rdquo;, &ldquo;New DWORD Setting&rdquo;, &ldquo;New String Setting&rdquo; under HKEY_LOCAL_MACHINE\System\Test\Test1 path.</div>
<p>&nbsp;</p>
<h2>More Information</h2>
<p>Below articles gives you additional details regarding adding, modifying, deleting registry sub keys, .reg file syntax
<a href="http://en.wikipedia.org/wiki/.reg">http://en.wikipedia.org/wiki/.reg</a></p>
<p>How to add, modify, or delete registry subkeys and values by using a registration entries (.reg) file
<a href="http://support.microsoft.com/kb/310516">http://support.microsoft.com/kb/310516</a></p>
<p>Note: If you want to verify that settings are added properly, enable remote desktop connection and connect to VM to verify the settings. Below article can help you enable remote desktop option to your Windows Azure VM&rsquo;s</p>
<p>How to connect to VM using Remote Desktop(RDP) on Windows Azure (Cloud)<a href="http://blogs.msdn.com/b/narahari/archive/2010/12/01/how-to-connect-to-vm-on-windows-azure.aspx">http://blogs.msdn.com/b/narahari/archive/2010/12/01/how-to-connect-to-vm-on-windows-azure.aspx</a></p>
<p>&nbsp;</p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img src="description/95e3bc78-76ea-4f7c-8b0e-445ca740f249image.png" alt="">
</a></div>

</div>


    </div>
</body>
</html>
