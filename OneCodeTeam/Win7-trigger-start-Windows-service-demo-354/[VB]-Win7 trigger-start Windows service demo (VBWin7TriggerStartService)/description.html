<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/1c1e217c-1475-400e-91a7-b2be1bd6efa0Combined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Win7 trigger-start Windows service demo (VBWin7TriggerStartService)</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Win7 trigger-start Windows service demo (VBWin7TriggerStartService)</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Windows 7
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Windows Service, Windows 7
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">11/27/2012</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MS-LPL</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/VBWin7TriggerStartService-6e3de7db">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Win7 trigger-start Windows service demo (<span style="">VB</span>Win7TriggerStartService)</h1>
<h2>Introduction</h2>
<p class="MsoNormal">Services and background processes have tremendous influence on the overall performance of the system. If we could just cut down on the total number of services, we would reduce the total power consumption and increase the overall stability
 of the system. The Windows 7 Service Control Manager has been extended so that a service can be automatically started and stopped when a specific system event, or trigger, occurs on the system. The new mechanism is called Service Trigger Event. A service can
 register to be started or stopped when a trigger event occurs. This enables services to start when needed instead of starting automatically whether or not there is work to do. Examples of predefined trigger events include arrival of a device of a specified
 device interface class or availability of a particular firewall port. A service can also register for a custom trigger event generated by an Event Tracing for Windows (ETW) provider.<span style="">
</span></p>
<p class="MsoNormal">This VB.NET code sample shows how to create a trigger-start service that starts when a generic USB disk becomes available. The sample also shows how to create a trigger-start service that starts a service when the first IP address on
 the TCP/IP networking stack becomes available, and stops a service when the last IP address on the TCP/IP networking stack becomes unavailable. These start and stop events are reported in the Application log.<span style="">
</span></p>
<h2>Running the Sample<span style=""> </span></h2>
<p class="MsoNormal"><span style=""></span></p>
<p class="MsoNormal"><span style="">You must run this code sample on a Windows Server 2008 R2 or Windows 7-based computer. Service trigger events are not supported until Windows Server 2008 R2 and Windows 7.
</span></p>
<p class="MsoNormal"><span style=""></span></p>
<p class="MsoListParagraphCxSpFirst" style=""><span style=""><span style="">A.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Demonstration of the trigger start service sample that starts when a generic USB disk becomes available
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">1.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Build the project. </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">After build, you will get a service application: VBWin7TriggerStartService.exe.
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">2.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Install Windows Service. </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">Run Visual Studio 2012 Command Prompt as administrator, navigate to the output folder of the sample project, and enter the following command to install the service:<span style="">&nbsp;
</span><b style=""><u>InstallUtil.exe VBWin7TriggerStartService.exe</u> </b></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">The service is successfully installed if the process outputs:
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span><span class="GramE">Beginning the Install phase of the installation.</span>
</span></i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span>...... </span></i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span>Installing service VBWin7TriggerStartService... </span></i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span>Service VBWin7TriggerStartService has been successfully installed. </span>
</i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span>Creating <span class="SpellE">EventLog</span> source VBWin7TriggerStartService in log Application...
</span></i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span>Configuring trigger-start service... </span></i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span>The Install phase completed successfully, and the Commit phase is beginning.
</span></i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span>...... </span></i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span>The Commit phase completed successfully. </span></i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><i style=""><span style=""><span style="">&nbsp;
</span>The transacted install has completed. </span></i></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">And then pen Service Management Console (<span class="SpellE">services.msc</span>). You should be able to find &quot;VBWin7TriggerStartService Sample Service&quot; in the service
 list. </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><img src="description/image.png" alt="" width="576" height="21" align="middle">
</span><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">3.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Trigger the service. </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">Plug in a generic USB disk to the computer, and refresh the service status in Service Management Console after a short while. You would find that VBWin7TriggerStartService Sample
 Service is trigger-started. </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><img src="description/a80cd591-6798-46e5-a5b2-711a4a5aec38image.png" alt="" width="578" height="66" align="middle">
</span><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">4.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Clean up </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">Run following command to uninstall the service.
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><b style=""><u><span style="">Installutil.exe /u VBWin7TriggerStartService.exe
</span></u></b></p>
<p class="MsoListParagraphCxSpMiddle"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style=""><span style=""><span style="">B.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Demonstration a trigger-start service that starts a service when the first IP address on the TCP/IP networking stack becomes available, and stops a service when the last IP address on the TCP/IP networking stack becomes unavailable.
</span></p>
<p class="MsoListParagraphCxSpMiddle"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">1.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Modify the source and rebuild. </span></p>
<p class="MsoListParagraphCxSpLast" style="margin-left:.75in"><span style="">In
<span class="SpellE">ProjectInstall.vb</span>, comment out the codes: </span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">vb</span>
<pre class="hidden">
ServiceTriggerStart.SetServiceTriggerStartOnUSBArrival( _
ServiceInstaller1.ServiceName)

</pre>
<pre id="codePreview" class="vb">
ServiceTriggerStart.SetServiceTriggerStartOnUSBArrival( _
ServiceInstaller1.ServiceName)

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoListParagraphCxSpFirst" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpLast" style="margin-left:.75in"><span class="GramE"><span style="">and</span></span><span style=""> uncomment the following codes:
</span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">vb</span>
<pre class="hidden">
ServiceTriggerStart.SetServiceTriggerStartOnIPAddressArrival( _
ServiceInstaller1.ServiceName)

</pre>
<pre id="codePreview" class="vb">
ServiceTriggerStart.SetServiceTriggerStartOnIPAddressArrival( _
ServiceInstaller1.ServiceName)

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoListParagraphCxSpFirst" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">2.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Redo the A.2 step to install the service. </span>
</p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">3.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Trigger the service. </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">Disconnect the computer from network. Make sure that the VBWin7TriggerStartService service is stopped at the moment. Plug in your network cable and refresh the service status in
 Service Management Console after the network is connected. You should find that the service is trigger-started. Next, unplug the network cable from your computer. You would see that the service is trigger-stopped in the meantime the network is disconnected.
</span></p>
<p class="MsoListParagraphCxSpMiddle"><span style=""></span></p>
<p class="MsoListParagraphCxSpLast" style="margin-left:.75in"><span style=""><span style="">4.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Redo the A.4 step to uninstall the service </span>
</p>
<h2>Using the Code</h2>
<p class="MsoListParagraphCxSpFirst" style=""><span style=""><span style="">A.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Creation </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">1.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Follow the steps in <a href="http://msdn.microsoft.com/en-us/library/9k985bc9.aspx">
http://msdn.microsoft.com/en-us/library/9k985bc9.aspx</a> to create a Windows Service Project named VBWin7TriggerStartService.
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">2.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Rename the default Service1 to the generic name &quot;Service&quot;. Open the service in designer and set the
<span class="SpellE"><b style="">ServiceName</b></span> property to be VBWin7TriggerStartService.
</span></p>
<p class="MsoListParagraphCxSpLast" style="margin-left:.75in"><span style=""><span style="">3.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Drag and drop an event log component from toolbox to the design view of the service, and set its Log property to be Application, and its Source to be VBWin7TriggerStartService. The event log component will be used to log
 some application messages in the <span class="SpellE"><b style="">OnStart</b></span> and
<span class="SpellE"><b style="">OnStop</b></span> functions of the service: </span>
</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">vb</span>
<pre class="hidden">
Protected Overrides Sub OnStart(ByVal args() As String)
    ' Add code here to start your service. This method should set things
    ' in motion so your service can do its work.
    Me.EventLog1.WriteEntry(&quot;VBWin7TriggerStartService is in OnStart.&quot;)
End Sub




Protected Overrides Sub OnStop()
    ' Add code here to perform any tear-down necessary to stop your service.
    Me.EventLog1.WriteEntry(&quot;VBWin7TriggerStartService is in OnStop.&quot;)
End Sub

</pre>
<pre id="codePreview" class="vb">
Protected Overrides Sub OnStart(ByVal args() As String)
    ' Add code here to start your service. This method should set things
    ' in motion so your service can do its work.
    Me.EventLog1.WriteEntry(&quot;VBWin7TriggerStartService is in OnStart.&quot;)
End Sub




Protected Overrides Sub OnStop()
    ' Add code here to perform any tear-down necessary to stop your service.
    Me.EventLog1.WriteEntry(&quot;VBWin7TriggerStartService is in OnStop.&quot;)
End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoListParagraphCxSpFirst" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">4.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Right-click in the design <span class="GramE">
view</span> of the service, and select Add Installer on the context menu. This creates the project installer components:
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">serviceProcessInstaller1
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">serviceInstaller1
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">Set the Account property of serviceProcessInstaller1 to be Local Service, so the service will be run as Local Service. As for serviceInstaller1, make its
<span class="SpellE"><b style="">ServiceName</b></span> property &quot;VBWin7TriggerStartService&quot;, and make its
<span class="SpellE"><b style="">DisplayName</b></span> &quot;VBWin7TriggerStartService Sample Service&quot;. Keep everything else the default value.
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style=""><span style=""><span style="">B.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Adding P/Invoke signatures for native APIs and
<span class="SpellE">structs</span> related to SCM </span></p>
<p class="MsoListParagraphCxSpMiddle"><span style="">Add a <span class="SpellE">
NativeMethods.vb</span> file and define P/Invoke signatures for native APIs like <b style="">
ChangeServiceConfig2</b>, <b style="">QueryServiceConfig2</b> and the related <span class="SpellE">
structs</span> and enumerations. </span></p>
<p class="MsoListParagraphCxSpMiddle"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style=""><span style=""><span style="">C.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Configuring the service to trigger-start when a generic USB disk becomes available (or trigger-start when the first IP address becomes
<span class="GramE">available,</span> and trigger-stop when the last IP address becomes unavailable.)
</span></p>
<p class="MsoListParagraphCxSpMiddle"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle"><span style="">Services can be registered as trigger-start from the sc.exe command line utility (using the
<span class="SpellE">sc</span> <span class="SpellE">triggerinfo</span> command and need to run the Command Shell as Administrator), or using the
<b style="">ChangeServiceConfig2</b> API programmatically. The service installer utility of .NET Windows Services (<span class="SpellE"><b style="">InstallUtil</b></span>) does not support
<span class="SpellE">triggerinfo</span> switch, so we do it programmatically. <span class="SpellE">
<span class="GramE">ServiceInstaller's</span></span><span class="GramE"><span style="">&nbsp;
</span><span class="SpellE">AfterInstall</span></span> event allows us to execute some codes after the
<span class="SpellE">serivce</span> is installed. We are going to register the service as trigger-start in this event handler.
</span></p>
<p class="MsoListParagraphCxSpMiddle"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""><span style="">1.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Add the helper class <span class="SpellE">ServiceTriggerStart.vb</span> to wrap and exposes some useful functions related to trigger start service.
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="margin-left:.75in; border-collapse:collapse; border:none">
<tbody>
<tr style="">
<td width="387" valign="top" style="width:290.55pt; border:solid windowtext 1.0pt; padding:0in 5.4pt 0in 5.4pt">
<p class="MsoListParagraphCxSpLast" style="margin-left:0in"><span class="SpellE"><span style="">ServiceTriggerStart.IsSupported</span></span><span style="">
</span></p>
</td>
<td width="483" valign="top" style="width:362.1pt; border:solid windowtext 1.0pt; border-left:none; padding:0in 5.4pt 0in 5.4pt">
<p class="MsoNormal"><span style="">Check whether the current system supports service trigger start. Service trigger events are not supported until Windows Server 2008 R2 and Windows 7. Windows Server 2008 R2 and Windows 7 have major version 6 and minor version
 1. </span></p>
</td>
</tr>
<tr style="">
<td width="387" valign="top" style="width:290.55pt; border:solid windowtext 1.0pt; border-top:none; padding:0in 5.4pt 0in 5.4pt">
<p class="MsoListParagraphCxSpFirst" style="margin-left:0in"><span class="SpellE"><span style="">ServiceTriggerStart.IsTriggerStartService</span></span><span style="">
</span></p>
</td>
<td width="483" valign="top" style="width:362.1pt; border-top:none; border-left:none; border-bottom:solid windowtext 1.0pt; border-right:solid windowtext 1.0pt; padding:0in 5.4pt 0in 5.4pt">
<p class="MsoListParagraphCxSpLast" style="margin-left:0in"><span style="">Determine whether the specified service is configured to trigger start.
</span></p>
</td>
</tr>
<tr style="">
<td width="387" valign="top" style="width:290.55pt; border:solid windowtext 1.0pt; border-top:none; padding:0in 5.4pt 0in 5.4pt">
<p class="MsoListParagraph" style="margin-left:0in"><span class="SpellE"><span style="">ServiceTriggerStart.SetServiceTriggerStartOnUSBArrival</span></span><span style="">
</span></p>
</td>
<td width="483" valign="top" style="width:362.1pt; border-top:none; border-left:none; border-bottom:solid windowtext 1.0pt; border-right:solid windowtext 1.0pt; padding:0in 5.4pt 0in 5.4pt">
<p class="MsoNormal"><span style="">Set the service to trigger-start when a generic USB disk becomes available.
</span></p>
</td>
</tr>
<tr style="">
<td width="387" valign="top" style="width:290.55pt; border:solid windowtext 1.0pt; border-top:none; padding:0in 5.4pt 0in 5.4pt">
<p class="MsoListParagraph" style="margin-left:0in"><span class="SpellE"><span style="">ServiceTriggerStart.SetServiceTriggerStartOnIPAddressArrival</span></span><span style="">
</span></p>
</td>
<td width="483" valign="top" style="width:362.1pt; border-top:none; border-left:none; border-bottom:solid windowtext 1.0pt; border-right:solid windowtext 1.0pt; padding:0in 5.4pt 0in 5.4pt">
<p class="MsoNormal"><span style="">Set the service to trigger-start when the first IP address on the TCP/IP networking stack becomes available, and trigger-stop when the last IP address on the TCP/IP networking stack becomes unavailable.
</span></p>
</td>
</tr>
</tbody>
</table>
<p class="MsoListParagraphCxSpFirst" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">Take
<span class="SpellE"><b style="">SetServiceTriggerStartOnUSBArrival</b></span> as an example. The function modifies service configuration by calling the Win32 API
<b style="">ChangeServiceConfig2</b> to set service trigger start on USB arrival.
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.0in"><span style=""><span style="">a.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Allocate a SERVICE_TRIGGER_SPECIFIC_DATA_ITEM structure
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.25in"><span style=""><span style=""><span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>i.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Set its <span class="SpellE">dwDataType</span> member to SERVICE_TRIGGER_DATA_TYPE_STRING
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.25in"><span style=""><span style=""><span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ii.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Set its <span class="SpellE">cbData</span> member to the length of the string L&quot;USBSTOR\\<span class="SpellE">GenDisk</span>&quot; in bytes
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.25in"><span style=""><span style=""><span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>iii.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Set its <span class="SpellE">pData</span> member to that string.
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.25in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.0in"><span style=""><span style="">b.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Allocate a SERVICE_TRIGGER structure </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.25in"><span style=""><span style=""><span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>i.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Set its <span class="SpellE">dwTriggerType</span> member to<span style="">&nbsp;
</span>SERVICE_TRIGGER_TYPE_DEVICE_INTERFACE_ARRIVAL </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.25in"><span style=""><span style=""><span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ii.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Set its <span class="SpellE">dwAction</span> member to SERVICE_TRIGGER_ACTION_SERVICE_START
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.25in"><span style=""><span style=""><span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>iii.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Set its <span class="SpellE">pTriggerSubtype</span> member to the address of the<span style="">&nbsp;&nbsp;
</span>GUID_DEVINTERFACE_DISK GUID </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.25in"><span style=""><span style=""><span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>iv.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Set its <span class="SpellE">cDataItems</span> member to 1 and its
<span class="SpellE">pDataItems</span> member to the address of the structure allocated in the previous step.
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.25in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.0in"><span style=""><span style="">c.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Allocate a SERVICE_TRIGGER_INFO structure </span>
</p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.0in"><span style="">Set its
<span class="SpellE">cTriggers</span> member to 1 and its <span class="SpellE">
pTriggers</span> member to the address<span style="">&nbsp;&nbsp;&nbsp; </span>of the structure allocated in the previous step.
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.0in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:1.0in"><span style=""><span style="">d.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Call the ChangeServiceConfig2 function with <span class="GramE">
the<b style=""><span style="">&nbsp; </span>SERVICE</b></span><b style="">_CONFIG_TRIGGER_INFO</b> information level and pass to it the address<span style="">&nbsp;
</span>of the structure allocated in the previous step. </span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">Please note that the above data structures are initially allocated on managed heap. We need to marshal them to the native memory by calling
<span class="SpellE">Marshal.AllocHGlobal</span> and <span class="SpellE">Marshal.StructureToPtr</span>, and free the native memory after use (<span class="SpellE">Marshal.FreeHGlobal</span>).
</span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">The complete code of setting service
<span class="SpellE">tigger</span> start on USB arrival is: </span></p>
<p class="MsoListParagraphCxSpLast" style="margin-left:.75in"><span style=""></span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">vb</span>
<pre class="hidden">
Dim pGuidUSBDevice As IntPtr = IntPtr.Zero
Dim pUSBHardwareId As IntPtr = IntPtr.Zero
Dim pDeviceData As IntPtr = IntPtr.Zero
Dim pServiceTrigger As IntPtr = IntPtr.Zero
Dim pServiceTriggerInfo As IntPtr = IntPtr.Zero


Try
    ' Marshal the Guid struct GUID_DEVINTERFACE_DISK to native memory


    pGuidUSBDevice = Marshal.AllocHGlobal(Marshal.SizeOf(GetType(Guid)))
    Marshal.StructureToPtr(GUID_DEVINTERFACE_DISK, pGuidUSBDevice, False)


    ' Allocate and set the SERVICE_TRIGGER_SPECIFIC_DATA_ITEM structure


    Dim deviceData As SERVICE_TRIGGER_SPECIFIC_DATA_ITEM
    deviceData.dwDataType = ServiceTriggerDataType.SERVICE_TRIGGER_DATA_TYPE_STRING
    deviceData.cbData = (USBHardwareId.Length &#43; 1) * 2
    pUSBHardwareId = Marshal.StringToHGlobalUni(USBHardwareId)
    deviceData.pData = pUSBHardwareId


    ' Marshal SERVICE_TRIGGER_SPECIFIC_DATA_ITEM to native memory


    pDeviceData = Marshal.AllocHGlobal( _
    Marshal.SizeOf(GetType(SERVICE_TRIGGER_SPECIFIC_DATA_ITEM)))
    Marshal.StructureToPtr(deviceData, pDeviceData, False)


    ' Allocate and set the SERVICE_TRIGGER structure


    Dim serviceTrigger As New SERVICE_TRIGGER
    serviceTrigger.dwTriggerType = _
    ServiceTriggerType.SERVICE_TRIGGER_TYPE_DEVICE_INTERFACE_ARRIVAL
    serviceTrigger.dwAction = _
    ServiceTriggerAction.SERVICE_TRIGGER_ACTION_SERVICE_START
    serviceTrigger.pTriggerSubtype = pGuidUSBDevice
    serviceTrigger.cDataItems = 1
    serviceTrigger.pDataItems = pDeviceData


    ' Marshal the SERVICE_TRIGGER struct to native memory


    pServiceTrigger = Marshal.AllocHGlobal( _
    Marshal.SizeOf(GetType(SERVICE_TRIGGER)))
    Marshal.StructureToPtr(serviceTrigger, pServiceTrigger, False)


    ' Allocate and set the SERVICE_TRIGGER_INFO structure


    Dim serviceTriggerInfo As New SERVICE_TRIGGER_INFO
    serviceTriggerInfo.cTriggers = 1
    serviceTriggerInfo.pTriggers = pServiceTrigger


    ' Marshal the SERVICE_TRIGGER_INFO struct to native memory


    pServiceTriggerInfo = Marshal.AllocHGlobal( _
    Marshal.SizeOf(GetType(SERVICE_TRIGGER_INFO)))
    Marshal.StructureToPtr(serviceTriggerInfo, pServiceTriggerInfo, False)


    ' Call ChangeServiceConfig2 with the SERVICE_CONFIG_TRIGGER_INFO level 
    ' and pass to it the address of the SERVICE_TRIGGER_INFO structure


    If Not NativeMethods.ChangeServiceConfig2( _
    hService, ServiceConfig2InfoLevel.SERVICE_CONFIG_TRIGGER_INFO, _
    pServiceTriggerInfo) Then
        ' If the handle is invalid, get the last Win32 error and throw a 
        ' Win32Exception
        Marshal.ThrowExceptionForHR(Marshal.GetHRForLastWin32Error)
    End If


Finally
    ' Clean up the native memory


    If (pGuidUSBDevice &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pGuidUSBDevice)
    End If
    If (pUSBHardwareId &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pUSBHardwareId)
    End If
    If (pDeviceData &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pDeviceData)
    End If
    If (pServiceTrigger &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pServiceTrigger)
    End If
    If (pServiceTriggerInfo &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pServiceTriggerInfo)
    End If
End Try

</pre>
<pre id="codePreview" class="vb">
Dim pGuidUSBDevice As IntPtr = IntPtr.Zero
Dim pUSBHardwareId As IntPtr = IntPtr.Zero
Dim pDeviceData As IntPtr = IntPtr.Zero
Dim pServiceTrigger As IntPtr = IntPtr.Zero
Dim pServiceTriggerInfo As IntPtr = IntPtr.Zero


Try
    ' Marshal the Guid struct GUID_DEVINTERFACE_DISK to native memory


    pGuidUSBDevice = Marshal.AllocHGlobal(Marshal.SizeOf(GetType(Guid)))
    Marshal.StructureToPtr(GUID_DEVINTERFACE_DISK, pGuidUSBDevice, False)


    ' Allocate and set the SERVICE_TRIGGER_SPECIFIC_DATA_ITEM structure


    Dim deviceData As SERVICE_TRIGGER_SPECIFIC_DATA_ITEM
    deviceData.dwDataType = ServiceTriggerDataType.SERVICE_TRIGGER_DATA_TYPE_STRING
    deviceData.cbData = (USBHardwareId.Length &#43; 1) * 2
    pUSBHardwareId = Marshal.StringToHGlobalUni(USBHardwareId)
    deviceData.pData = pUSBHardwareId


    ' Marshal SERVICE_TRIGGER_SPECIFIC_DATA_ITEM to native memory


    pDeviceData = Marshal.AllocHGlobal( _
    Marshal.SizeOf(GetType(SERVICE_TRIGGER_SPECIFIC_DATA_ITEM)))
    Marshal.StructureToPtr(deviceData, pDeviceData, False)


    ' Allocate and set the SERVICE_TRIGGER structure


    Dim serviceTrigger As New SERVICE_TRIGGER
    serviceTrigger.dwTriggerType = _
    ServiceTriggerType.SERVICE_TRIGGER_TYPE_DEVICE_INTERFACE_ARRIVAL
    serviceTrigger.dwAction = _
    ServiceTriggerAction.SERVICE_TRIGGER_ACTION_SERVICE_START
    serviceTrigger.pTriggerSubtype = pGuidUSBDevice
    serviceTrigger.cDataItems = 1
    serviceTrigger.pDataItems = pDeviceData


    ' Marshal the SERVICE_TRIGGER struct to native memory


    pServiceTrigger = Marshal.AllocHGlobal( _
    Marshal.SizeOf(GetType(SERVICE_TRIGGER)))
    Marshal.StructureToPtr(serviceTrigger, pServiceTrigger, False)


    ' Allocate and set the SERVICE_TRIGGER_INFO structure


    Dim serviceTriggerInfo As New SERVICE_TRIGGER_INFO
    serviceTriggerInfo.cTriggers = 1
    serviceTriggerInfo.pTriggers = pServiceTrigger


    ' Marshal the SERVICE_TRIGGER_INFO struct to native memory


    pServiceTriggerInfo = Marshal.AllocHGlobal( _
    Marshal.SizeOf(GetType(SERVICE_TRIGGER_INFO)))
    Marshal.StructureToPtr(serviceTriggerInfo, pServiceTriggerInfo, False)


    ' Call ChangeServiceConfig2 with the SERVICE_CONFIG_TRIGGER_INFO level 
    ' and pass to it the address of the SERVICE_TRIGGER_INFO structure


    If Not NativeMethods.ChangeServiceConfig2( _
    hService, ServiceConfig2InfoLevel.SERVICE_CONFIG_TRIGGER_INFO, _
    pServiceTriggerInfo) Then
        ' If the handle is invalid, get the last Win32 error and throw a 
        ' Win32Exception
        Marshal.ThrowExceptionForHR(Marshal.GetHRForLastWin32Error)
    End If


Finally
    ' Clean up the native memory


    If (pGuidUSBDevice &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pGuidUSBDevice)
    End If
    If (pUSBHardwareId &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pUSBHardwareId)
    End If
    If (pDeviceData &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pDeviceData)
    End If
    If (pServiceTrigger &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pServiceTrigger)
    End If
    If (pServiceTriggerInfo &lt;&gt; IntPtr.Zero) Then
        Marshal.FreeHGlobal(pServiceTriggerInfo)
    End If
End Try

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoListParagraphCxSpFirst" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpLast" style="margin-left:.75in"><span style="">Please note that, in the above code, the service handle (<span class="SpellE">schService</span>) must be opened or created with the SERVICE_CHANGE_CONFIG access permission:
</span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">vb</span>
<pre class="hidden">
Dim schService As SafeServiceHandle = NativeMethods.OpenService( _
schSCManager, serviceName, ServiceAccessRights.SERVICE_CHANGE_CONFIG)

</pre>
<pre id="codePreview" class="vb">
Dim schService As SafeServiceHandle = NativeMethods.OpenService( _
schSCManager, serviceName, ServiceAccessRights.SERVICE_CHANGE_CONFIG)

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoListParagraphCxSpFirst" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpLast" style="margin-left:.75in"><span style=""><span style="">2.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span style="">Add the <span class="SpellE">AfterInstall</span> event handler of serviceInstaller1.
</span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">vb</span>
<pre class="hidden">
Private Sub ServiceInstaller1_AfterInstall(ByVal sender As <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Object.aspx"  title="Auto generated link to System.Object">System.Object</a>, _
ByVal e As <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Configuration.Install.InstallEventArgs.aspx"  title="Auto generated link to System.Configuration.Install.InstallEventArgs">System.Configuration.Install.InstallEventArgs</a>) _
Handles ServiceInstaller1.AfterInstall


End Sub

</pre>
<pre id="codePreview" class="vb">
Private Sub ServiceInstaller1_AfterInstall(ByVal sender As <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Object.aspx"  title="Auto generated link to System.Object">System.Object</a>, _
ByVal e As <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Configuration.Install.InstallEventArgs.aspx"  title="Auto generated link to System.Configuration.Install.InstallEventArgs">System.Configuration.Install.InstallEventArgs</a>) _
Handles ServiceInstaller1.AfterInstall


End Sub

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoListParagraphCxSpFirst" style="margin-left:.75in"><span style=""></span></p>
<p class="MsoListParagraphCxSpMiddle" style="margin-left:.75in"><span style="">In the event handler, determine if the current operating system supports service trigger events (<span class="SpellE">ServiceTriggerStart.IsSupported</span>), and configure the
 service to trigger start if applicable. (<span class="SpellE">ServiceTriggerStart.SetServiceTriggerStartOnUSBArrival</span> /
<span class="SpellE">ServiceTriggerStart.SetServiceTriggerStartOnIPAddressArrival</span>)
</span></p>
<p class="MsoListParagraphCxSpLast" style="margin-left:.75in"><span style=""></span></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>VB</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span>
</div>
<span class="hidden">vb</span>
<pre class="hidden">
If (ServiceTriggerStart.IsSupported) Then
    ServiceTriggerStart.SetServiceTriggerStartOnUSBArrival( _
    ServiceInstaller1.ServiceName)
    ' [-or-]
    'ServiceTriggerStart.SetServiceTriggerStartOnIPAddressArrival( _
    'ServiceInstaller1.ServiceName)
End If

</pre>
<pre id="codePreview" class="vb">
If (ServiceTriggerStart.IsSupported) Then
    ServiceTriggerStart.SetServiceTriggerStartOnUSBArrival( _
    ServiceInstaller1.ServiceName)
    ' [-or-]
    'ServiceTriggerStart.SetServiceTriggerStartOnIPAddressArrival( _
    'ServiceInstaller1.ServiceName)
End If

</pre>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p class="MsoNormal"><span style=""></span></p>
<h2>More Information</h2>
<p class="MsoListParagraphCxSpFirst" style=""><span style="font-family:Symbol"><span style="">&bull;<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><a href="http://msdn.microsoft.com/en-us/library/dd405513(VS.85).aspx">MSDN: Service Trigger Events</a></p>
<p class="MsoListParagraphCxSpMiddle" style=""><span style="font-family:Symbol"><span style="">&bull;<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><a href="http://www.microsoft.com/downloads/details.aspx?familyid=1C333F06-FADB-4D93-9C80-402621C600E7&amp;displaylang=en">Windows 7 Training Kit For Developers</a></p>
<p class="MsoListParagraphCxSpLast" style=""><span style="font-family:Symbol"><span style="">&bull;<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><a href="http://support.microsoft.com/kb/975425/en-us">KB: How to create a trigger-start Windows service in Windows 7</a>
</p>
<hr>
<div><a href="http://go.microsoft.com/?linkid=9759640" style="margin-top:3px"><img alt="" src="description/f0ce43d4-e8ea-415f-bfdd-f6bb39d3f968image.png">
</a></div>

</div>


    </div>
</body>
</html>
